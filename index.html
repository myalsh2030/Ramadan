<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محوّل جداول رمضان</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@300;400;500;600;700&family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        /* ═══════════ VARIABLES ═══════════ */
        :root {
            --bg: #F6F4EE;
            --sf: #FFF;
            --sf2: #FAFAF6;
            --pri: #1A4D2E;
            --prl: #2D7A4A;
            --prp: #E8F0EB;
            --acc: #C9A84C;
            --acg: rgba(232, 201, 104, .25);
            --txt: #1A1A1A;
            --mut: #6B7280;
            --bd: #E5E1D8;
            --bd2: #C8C3B8;
            --ok: #16A34A;
            --dn: #DC2626;
            --ff: 'Readex Pro', 'IBM Plex Sans Arabic', sans-serif;
            --fb: 'IBM Plex Sans Arabic', sans-serif
        }

        /* ═══════════ RESET ═══════════ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0
        }

        html {
            font-size: 15px
        }

        body {
            font-family: var(--fb);
            background: var(--bg);
            color: var(--txt);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 20% 20%, var(--prp) 0%, transparent 50%), radial-gradient(circle at 80% 80%, var(--acg) 0%, transparent 50%);
            opacity: .5;
            pointer-events: none;
            z-index: 0
        }

        /* ═══════════ LAYOUT ═══════════ */
        .app {
            position: relative;
            z-index: 1;
            max-width: 1020px;
            margin: 0 auto;
            padding: 24px 20px
        }

        .hdr {
            text-align: center;
            margin-bottom: 28px;
            animation: fsd .6s ease-out
        }

        .hdr h1 {
            font-family: var(--ff);
            font-size: 2rem;
            font-weight: 700;
            color: var(--pri);
            letter-spacing: -.5px
        }

        .hdr .cr {
            display: inline-flex;
            align-items: center;
            margin-inline-start: 8px;
            animation: gfl 3s ease-in-out infinite;
            color: var(--acc)
        }

        .hdr .sub {
            font-size: .88rem;
            color: var(--mut);
            margin-top: 2px
        }

        /* ═══════════ STEPPER ═══════════ */
        .stepper {
            display: flex;
            justify-content: center;
            margin-bottom: 32px;
            animation: fsd .6s ease-out .1s both
        }

        .si {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            font-size: .85rem;
            font-weight: 500;
            color: var(--mut);
            cursor: pointer;
            transition: .3s;
            border-radius: 24px
        }

        .si.act {
            color: var(--pri);
            background: var(--prp);
            font-weight: 600
        }

        .si.dn {
            color: var(--ok)
        }

        .sn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: .78rem;
            font-weight: 700;
            border: 2px solid var(--bd);
            background: var(--sf);
            transition: .3s
        }

        .si.act .sn {
            border-color: var(--pri);
            background: var(--pri);
            color: #fff
        }

        .si.dn .sn {
            border-color: var(--ok);
            background: var(--ok);
            color: #fff
        }

        .sc {
            width: 40px;
            height: 2px;
            background: var(--bd);
            align-self: center;
            transition: .3s
        }

        .sc.done {
            background: var(--ok)
        }

        /* ═══════════ SCREENS ═══════════ */
        .scr {
            display: none;
            animation: fsu .4s ease-out
        }

        .scr.active {
            display: block
        }

        .card {
            background: var(--sf);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
            border: 1px solid var(--bd);
            margin-bottom: 20px
        }

        .ct {
            font-family: var(--ff);
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--pri);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        /* ═══════════ UPLOAD ═══════════ */
        .uz {
            border: 2px dashed var(--bd2);
            border-radius: 16px;
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: .3s;
            background: var(--sf2)
        }

        .uz:hover,
        .uz.dg {
            border-color: var(--pri);
            background: var(--prp);
            transform: scale(1.01)
        }

        .uz .uzi {
            font-size: 3rem;
            margin-bottom: 12px;
            display: block;
            opacity: .7
        }

        .uz .uzt {
            font-size: 1rem;
            font-weight: 500
        }

        .uz .uzh {
            font-size: .8rem;
            color: var(--mut)
        }

        /* ═══════════ STATS ═══════════ */
        .stb {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 20px
        }

        .sti {
            background: var(--sf2);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
            border: 1px solid var(--bd)
        }

        .stv {
            font-family: var(--ff);
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--pri)
        }

        .stl {
            font-size: .75rem;
            color: var(--mut);
            margin-top: 2px
        }

        /* ═══════════ SETTINGS ═══════════ */
        .sg {
            display: grid;
            gap: 0
        }

        .sg-columns {
            display: grid;
            grid-template-columns: 1fr 20px 1fr;
            gap: 0;
            align-items: start
        }

        .sg-col {
            display: flex;
            flex-direction: column;
            gap: 0
        }

        .sg-col-title {
            text-align: center;
            font-weight: 700;
            font-size: .8rem;
            padding: 8px 4px;
            border-radius: 8px 8px 0 0
        }

        .sg-col-ramadan .sg-col-title {
            background: linear-gradient(135deg, #1A4D2E, #2D7A4A);
            color: #fff
        }

        .sg-col-old .sg-col-title {
            background: #d5d0c8;
            color: #555
        }

        .sg-col-divider {
            display: flex;
            align-items: stretch;
            justify-content: center
        }

        .sg-col-divider::after {
            content: '';
            width: 2px;
            background: var(--bd2);
            margin: 8px 0
        }

        .sr-row {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 8px;
            border: 1px solid transparent;
            border-bottom: 1px solid var(--bd);
            transition: .2s;
            min-height: 44px
        }

        .sg-col-ramadan .sr-row {
            background: #f0f8f2
        }

        .sg-col-ramadan .sr-row:hover {
            background: #e0f0e4
        }

        .sg-col-old .sr-row {
            background: #f5f3ef
        }

        .sr-row .srl {
            font-weight: 600;
            font-size: .8rem;
            color: var(--pri);
            min-width: 85px;
            flex-shrink: 0
        }

        .sg-col-old .sr-row .srl {
            color: var(--mut)
        }

        .time-cell {
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 1;
            justify-content: center
        }

        .time-val {
            font-family: 'Courier New', monospace;
            font-size: .85rem;
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            direction: ltr;
            min-width: 48px;
            display: inline-block
        }

        .sg-col-ramadan .time-val {
            background: #fff;
            border: 1px solid var(--prl);
            color: var(--pri);
            font-weight: 600
        }

        .sg-col-ramadan .time-val.end-val {
            background: var(--prp);
            border: 1px solid var(--bd);
            color: var(--pri);
            font-weight: 500;
            width: 105px;
            padding: 4px 4px;
            font-size: .85rem
        }

        .sg-col-old .time-val.end-val {
            width: 105px;
            padding: 4px 4px;
            font-size: .85rem
        }

        .sg-col-old .time-val {
            background: #eae7e1;
            border: 1px solid var(--bd);
            color: var(--mut);
            font-weight: 400
        }

        .time-sep {
            color: var(--mut);
            font-size: .75rem
        }

        /* 12h hint wrapper */
        .time-wrap {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
        }

        /* 12h hint below 24h time */
        .t12-hint {
            display: block;
            font-size: .62rem;
            color: #5c8a8a;
            opacity: .85;
            line-height: 1;
            margin-top: 2px;
            font-family: inherit;
            direction: ltr;
        }

        /* Colored dot indicator for old slot source */
        .slot-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
            flex-shrink: 0;
        }

        /* Tooltip balloon for old slots */
        .has-slot-tip {
            position: relative;
            cursor: help;
        }

        .has-slot-tip::after {
            content: attr(data-slot-tip);
            position: absolute;
            bottom: calc(100% + 6px);
            right: 0;
            background: #1a1a2e;
            color: #fff;
            font-size: .72rem;
            line-height: 1.5;
            padding: 8px 12px;
            border-radius: 8px;
            white-space: pre-line;
            min-width: 220px;
            max-width: 340px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, .25);
            opacity: 0;
            pointer-events: none;
            transition: opacity .2s;
            z-index: 100;
            direction: rtl;
            text-align: right;
        }

        .has-slot-tip:hover::after {
            opacity: 1;
        }

        /* Arrow buttons */
        .arrow-btn {
            display: flex;
            flex-direction: column;
            gap: 1px
        }

        .arrow-btn button {
            border: 1px solid var(--bd);
            background: var(--sf);
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .15s;
            color: var(--pri);
            font-size: .55rem;
            line-height: 1
        }

        .arrow-btn button:first-child {
            border-radius: 3px 3px 0 0
        }

        .arrow-btn button:last-child {
            border-radius: 0 0 3px 3px;
            border-top: none
        }

        .arrow-btn button:hover {
            background: var(--prp);
            border-color: var(--prl)
        }

        .arrow-btn button:active {
            background: var(--pri);
            color: #fff
        }

        /* Break rows */
        .brk-row {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            min-height: 22px;
            font-size: .7rem;
            font-weight: 500
        }

        .sg-col-ramadan .brk-row {
            background: linear-gradient(90deg, transparent, rgba(26, 77, 46, .06), transparent);
            color: var(--pri)
        }

        .sg-col-ramadan .brk-row.brk-rest {
            color: var(--acc)
        }

        .sg-col-ramadan .brk-row.brk-none {
            color: var(--bd2);
            font-size: .6rem
        }

        .sg-col-old .brk-row {
            background: linear-gradient(90deg, transparent, rgba(0, 0, 0, .03), transparent);
            color: var(--mut)
        }

        .sg-col-old .brk-row.brk-none {
            color: var(--bd2);
            font-size: .6rem
        }

        /* Start time input */
        .start-input {
            width: 105px;
            padding: 4px 4px;
            border: 1.5px solid var(--prl);
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: .85rem;
            text-align: center;
            background: #fff;
            color: var(--pri);
            font-weight: 600;
            transition: .2s
        }

        .start-input:focus {
            outline: none;
            border-color: var(--pri);
            box-shadow: 0 0 0 3px var(--prp)
        }

        .ct .lucide-icon {
            width: 20px;
            height: 20px;
            stroke: var(--pri);
            flex-shrink: 0
        }

        /* ═══════════ LOGO (removed upload section) ═══════════ */

        /* ═══════════ SEARCH & LIST ═══════════ */
        .sbx {
            position: relative;
            margin-bottom: 16px
        }

        .sbx input {
            width: 100%;
            padding: 12px 44px 12px 16px;
            border: 1px solid var(--bd);
            border-radius: 10px;
            font-family: var(--fb);
            font-size: .9rem;
            background: var(--sf);
            transition: .2s
        }

        .sbx input:focus {
            outline: none;
            border-color: var(--pri);
            box-shadow: 0 0 0 3px var(--prp)
        }

        .sbx .sic {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.1rem;
            opacity: .4
        }

        .tl {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--bd);
            border-radius: 10px
        }

        .ti {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--bd);
            cursor: pointer;
            transition: .2s
        }

        .ti:last-child {
            border-bottom: none
        }

        .ti:hover,
        .ti.sel {
            background: var(--prp)
        }

        .tn {
            font-weight: 500;
            font-size: .9rem;
            flex: 1
        }

        .tid2 {
            font-size: .8rem;
            color: var(--mut);
            font-family: 'Courier New', monospace;
            direction: ltr
        }

        .tde {
            font-size: .75rem;
            color: var(--mut)
        }

        /* ═══════════ BUTTONS ═══════════ */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border: none;
            border-radius: 10px;
            font-family: var(--fb);
            font-size: .9rem;
            font-weight: 600;
            cursor: pointer;
            transition: .25s;
            white-space: nowrap
        }

        .btn:disabled {
            opacity: .4;
            cursor: not-allowed
        }

        .bp {
            background: var(--pri);
            color: #fff
        }

        .bp:hover:not(:disabled) {
            background: var(--prl);
            transform: translateY(-1px)
        }

        .ba {
            background: linear-gradient(135deg, var(--acc), #D4B85A);
            color: #1A1A1A
        }

        .ba:hover:not(:disabled) {
            box-shadow: 0 0 40px var(--acg);
            transform: translateY(-1px)
        }

        .bo {
            background: transparent;
            border: 1.5px solid var(--bd2);
            color: var(--txt)
        }

        .bo:hover:not(:disabled) {
            border-color: var(--pri);
            background: var(--prp)
        }

        .bsm {
            padding: 6px 14px;
            font-size: .8rem
        }

        .ab {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap
        }

        /* ═══════════ PROGRESS ═══════════ */
        .pw {
            display: none;
            margin-top: 16px
        }

        .pw.sh {
            display: block
        }

        .pb {
            width: 100%;
            height: 8px;
            background: var(--bd);
            border-radius: 99px;
            overflow: hidden
        }

        .pfl {
            height: 100%;
            background: linear-gradient(90deg, var(--pri), var(--acc));
            border-radius: 99px;
            transition: width .3s;
            width: 0%
        }

        .ptx {
            text-align: center;
            font-size: .8rem;
            color: var(--mut);
            margin-top: 6px
        }

        /* ═══════════ TOAST ═══════════ */
        .toc {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .tst {
            padding: 12px 20px;
            border-radius: 10px;
            font-size: .85rem;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0, 0, 0, .1);
            animation: tin .3s ease-out;
            max-width: 400px
        }

        .tst.ok {
            background: #F0FDF4;
            color: var(--ok);
            border: 1px solid var(--ok)
        }

        .tst.er {
            background: #FEF2F2;
            color: var(--dn);
            border: 1px solid var(--dn)
        }

        /* ═══════════ ANIMATIONS ═══════════ */
        @keyframes fsd {
            from {
                opacity: 0;
                transform: translateY(-16px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes fsu {
            from {
                opacity: 0;
                transform: translateY(16px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes gfl {

            0%,
            100% {
                transform: translateY(0) rotate(0)
            }

            50% {
                transform: translateY(-4px) rotate(5deg)
            }
        }

        @keyframes tin {
            from {
                opacity: 0;
                transform: translateY(-12px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2.5px solid var(--bd);
            border-top-color: var(--pri);
            border-radius: 50%;
            animation: spin .7s linear infinite
        }

        ::-webkit-scrollbar {
            width: 6px
        }

        ::-webkit-scrollbar-track {
            background: var(--bg)
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bd2);
            border-radius: 99px
        }

        .print-notice {
            margin-top: 20px;
            padding: 12px 14px;
            background: #fffcf0;
            border: 1px solid #f0e6c5;
            border-right: 4px solid var(--acc);
            border-radius: 8px;
            font-size: 0.82rem;
            line-height: 1.6;
            color: #7c5e10;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        /* ═══════════ RESPONSIVE ═══════════ */
        @media(max-width:768px) {
            .g3 {
                grid-template-columns: 1fr !important
            }
        }

        @media(max-width:640px) {
            html {
                font-size: 14px
            }

            .app {
                padding: 16px 12px
            }

            .card {
                padding: 20px 16px
            }

            .stepper {
                flex-wrap: wrap;
                gap: 4px
            }

            .sc {
                width: 20px
            }

            .si {
                padding: 8px 12px;
                font-size: .8rem
            }

            .stb {
                grid-template-columns: repeat(2, 1fr)
            }

            .sg-columns {
                grid-template-columns: 1fr 10px 1fr
            }

            .sr-row .srl {
                min-width: 75px;
                font-size: .7rem
            }

            .start-input {
                width: 95px;
                font-size: .78rem
            }

            .time-val {
                font-size: .75rem;
                min-width: 40px;
                padding: 3px 4px
            }

            .arrow-btn button {
                width: 16px;
                height: 12px
            }

            .ab {
                flex-direction: column
            }

            .ab .btn {
                width: 100%;
                justify-content: center
            }
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /*  PRINT-ONLY SCHEDULE PAGES                                      */
        /* ═══════════════════════════════════════════════════════════════ */
        #printArea {
            display: none
        }

        .sched-page {
            page-break-after: always;
            width: 210mm;
            /* A4 width */
            padding: 12mm 15mm;
            font-family: 'IBM Plex Sans Arabic', 'Readex Pro', sans-serif;
            direction: rtl;
            font-size: 13px;
            color: #000;
        }

        .sched-page:last-child {
            page-break-after: avoid
        }

        .sp-logo {
            text-align: center;
            margin-bottom: 6px
        }

        .sp-logo img {
            max-height: 30mm;
            max-width: 38mm
        }

        /* ═══ HEADER 3-COLUMN LAYOUT ═══ */
        .sp-header-row {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            margin-bottom: 5mm;
            direction: rtl;
        }

        .sp-header-logo {
            text-align: right;
        }

        .sp-header-logo img {
            max-height: 28mm;
            max-width: 36mm;
        }

        .sp-header-text {
            text-align: center;
            font-size: 14px;
            line-height: 1.8;
            color: #222;
            font-weight: 500;
        }

        .sp-header-empty {
            min-width: 0;
        }

        /* ═══ SEMESTER BADGE ═══ */
        .sp-semester {
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            color: #1A4D2E;
            margin: 1mm auto 2mm;
            padding: 2mm 6mm;
            background: #E8F0EB;
            border-radius: 3mm;
            display: inline-block;
        }

        .sp-semester-wrap {
            text-align: center;
            margin-bottom: 2mm;
        }

        /* ═══ DAY SEPARATOR ═══ */
        .sp-tbl .day-separator td {
            border-top: 2.5px solid #1A4D2E !important;
            padding-top: 3mm;
        }

        .sp-hdr {
            text-align: center;
            font-size: 13px;
            line-height: 1.8;
            color: #222;
            margin-bottom: 5mm
        }

        .sp-title {
            text-align: center;
            background: #1A4D2E;
            color: #fff;
            padding: 3.5mm 8mm;
            border-radius: 3mm;
            font-size: 16px;
            font-weight: 700;
            margin: 2mm auto;
            display: inline-block;
            letter-spacing: 0.3px;
        }

        .sp-title-wrap {
            text-align: center;
            margin-bottom: 3mm
        }

        .sp-info {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 4mm;
            font-size: 12px
        }

        .sp-info td {
            border: 0.5px solid #ccc;
            padding: 2.5mm 3mm;
            text-align: center
        }

        .sp-info .lbl {
            background: #E8F0EB;
            font-weight: 700;
            width: 14%;
            font-size: 11px;
            color: #1A4D2E
        }

        .sp-info td:nth-child(2) {
            width: 36%;
        }

        .sp-info td:nth-child(4) {
            width: 36%;
        }

        .sp-tbl {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px
        }

        .sp-tbl th {
            background: #1A4D2E;
            color: #fff;
            padding: 2.5mm 2mm;
            font-weight: 600;
            text-align: center;
            font-size: 11px;
            white-space: nowrap
        }

        .sp-tbl td {
            border: 0.5px solid #bbb;
            padding: 2mm 1.5mm;
            text-align: center;
            vertical-align: middle;
            font-size: 11px
        }

        .sp-tbl tr:nth-child(even) td {
            background: #f9f9f6
        }

        .sp-tbl .day-c {
            font-weight: 700;
            background: #E8F0EB !important;
            color: #1A4D2E;
            width: 8%
        }

        .sp-tbl .time-c {
            font-family: 'Courier New', monospace;
            direction: rtl;
            font-size: 11px;
            font-weight: 700;
            white-space: nowrap;
            width: 18%;
            min-width: 30mm;
        }

        .sp-footer {
            text-align: center;
            font-size: 12px;
            margin-top: 5mm;
            color: #444;
            font-weight: 600
        }

        /* ═══ UNIT NAME EDITOR ═══ */
        .unit-edit-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--sf2);
            border: 1px solid var(--bd);
            border-radius: 10px;
        }

        .unit-edit-wrap label {
            font-weight: 600;
            font-size: .88rem;
            color: var(--pri);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .unit-edit-wrap input {
            flex: 1;
            padding: 8px 12px;
            border: 1.5px solid var(--bd2);
            border-radius: 8px;
            font-family: var(--fb);
            font-size: .9rem;
            background: #fff;
            color: var(--txt);
            transition: .2s;
        }

        .unit-edit-wrap input:focus {
            outline: none;
            border-color: var(--pri);
            box-shadow: 0 0 0 3px var(--prp);
        }

        @media print {
            body>*:not(#printArea) {
                display: none !important
            }

            #printArea {
                display: block !important
            }

            body {
                background: #fff;
                margin: 0;
                padding: 0
            }

            body::before {
                display: none
            }

            @page {
                size: A4 portrait;
                margin: 0
            }

            .unit-edit-wrap,
            .controls-bar {
                display: none !important;
            }

            .sched-page {
                width: 100%;
                padding: 10mm 15mm;
                page-break-after: always
            }
        }

        /* ═══ CONTROLS BAR ═══ */
        .controls-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 16px;
            align-items: stretch;
        }

        .ctrl-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: var(--sf2);
            border: 1px solid var(--bd);
            border-radius: 10px;
            flex-shrink: 0;
        }

        .ctrl-group label {
            font-weight: 600;
            font-size: .82rem;
            color: var(--pri);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ctrl-group select {
            padding: 6px 10px;
            border: 1.5px solid var(--bd2);
            border-radius: 7px;
            font-family: var(--fb);
            font-size: .85rem;
            background: #fff;
            color: var(--txt);
            cursor: pointer;
            transition: .2s;
        }

        .ctrl-group select:focus {
            outline: none;
            border-color: var(--pri);
            box-shadow: 0 0 0 3px var(--prp);
        }

        .notes-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .notes-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notes-header label {
            font-weight: 600;
            font-size: .82rem;
            color: var(--pri);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .note-add-btn {
            background: var(--pri);
            color: #fff;
            border: none;
            border-radius: 6px;
            width: 28px;
            height: 28px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .2s;
        }

        .note-add-btn:hover {
            background: var(--prh);
            transform: scale(1.1);
        }

        .note-entry {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            background: var(--sf2);
            border: 1px solid var(--bd);
            border-radius: 10px;
            padding: 10px 14px;
        }

        .note-entry textarea {
            flex: 1;
            padding: 6px 10px;
            border: 1.5px solid var(--bd2);
            border-radius: 7px;
            font-family: var(--fb);
            font-size: .85rem;
            background: #fff;
            color: var(--txt);
            transition: .2s;
            resize: vertical;
            min-height: 36px;
            line-height: 1.6;
        }

        .note-entry textarea:focus {
            outline: none;
            border-color: var(--pri);
            box-shadow: 0 0 0 3px var(--prp);
        }

        .note-remove-btn {
            background: none;
            border: none;
            color: #c62828;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 4px;
            border-radius: 50%;
            transition: .2s;
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-remove-btn:hover {
            background: rgba(198, 40, 40, 0.1);
        }

        .note-num {
            font-size: .72rem;
            color: var(--mut);
            font-weight: 700;
            min-width: 18px;
            text-align: center;
            padding-top: 8px;
            flex-shrink: 0;
        }

        /* ═══ SCHEDULE NOTE ═══ */
        .sp-note {
            text-align: center;
            font-size: 12px;
            margin-top: 2mm;
            color: #b8860b;
            font-weight: 700;
            line-height: 1.7;
            padding: 2mm 4mm;
            border-radius: 4px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.12), rgba(255, 165, 0, 0.10));
            border: 1px solid rgba(218, 165, 32, 0.35);
            animation: noteGlow 2s ease-in-out infinite alternate;
            white-space: pre-line;
        }

        .sp-note+.sp-note {
            margin-top: 1.5mm;
        }

        @keyframes noteGlow {
            0% {
                box-shadow: 0 0 4px rgba(255, 193, 7, 0.3), 0 0 8px rgba(255, 193, 7, 0.15);
            }

            100% {
                box-shadow: 0 0 8px rgba(255, 193, 7, 0.6), 0 0 16px rgba(255, 193, 7, 0.3), 0 0 24px rgba(255, 193, 7, 0.15);
            }
        }

        @media print {
            .sp-note {
                animation: none !important;
                box-shadow: none !important;
                color: #8B6914 !important;
                border: 1.5px solid #DAA520 !important;
                background: rgba(255, 215, 0, 0.08) !important;
            }
        }

        /* ═══ INVISIBLE SEARCHABLE TEXT LAYER ═══ */
        /* This layer embeds trainee names as real selectable/searchable text
           using basic system fonts (Arial/Tahoma) that every device supports.
           The text is invisible visually but remains in the PDF text stream,
           enabling search on mobile PDF readers (iOS/Android). */
        .sp-search-layer {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            overflow: hidden;
            height: 1px;
            opacity: 0.01;
            /* near-invisible but forces PDF text embedding */
            font-family: Arial, Tahoma, 'Segoe UI', sans-serif !important;
            font-size: 1px !important;
            line-height: 1px !important;
            color: rgba(255, 255, 255, 0.01) !important;
            pointer-events: none;
            user-select: text;
            /* must be selectable for PDF search */
            -webkit-user-select: text;
            z-index: -1;
            direction: rtl;
            unicode-bidi: embed;
            font-weight: 400 !important;
            letter-spacing: 0 !important;
            word-spacing: 0 !important;
            text-rendering: auto !important;
            -webkit-font-smoothing: auto !important;
        }

        /* Ensure sched-page is positioned for the absolute search layer */
        .sched-page {
            position: relative;
        }

        /* ═══ VERSION BADGE ═══ */
        .version-badge {
            display: inline-block;
            margin-top: 8px;
            padding: 3px 14px;
            font-size: .72rem;
            font-weight: 600;
            color: var(--pri);
            background: var(--prp);
            border: 1px solid var(--bd);
            border-radius: 20px;
            letter-spacing: .5px;
            opacity: .8;
        }
    </style>
</head>

<body>
    <div class="toc" id="TC"></div>
    <div class="app">
        <header class="hdr">
            <h1>محوّل جداول رمضان <span class="cr"><i data-lucide="moon"></i></span></h1>
            <p class="sub">تحويل جداول المتدربين من نظام 50 دقيقة إلى نظام 35 دقيقة</p>
            <span class="version-badge" id="verBadge">v1.8.0</span>
            <p style="font-size:.68rem;color:var(--mut);margin-top:6px;opacity:.8"><i data-lucide="globe"
                    style="width:12px;height:12px;vertical-align:middle;margin-left:3px"></i> يعمل بشكل أفضل مع متصفح
                Google Chrome</p>
        </header>
        <nav class="stepper">
            <div class="si act" data-s="1" onclick="goTo(1)"><span class="sn">1</span><span>رفع الملف</span></div>
            <div class="sc" id="c1"></div>
            <div class="si" data-s="2" onclick="goTo(2)"><span class="sn">2</span><span>الإعدادات</span></div>
            <div class="sc" id="c2"></div>
            <div class="si" data-s="3" onclick="goTo(3)"><span class="sn">3</span><span>المعاينة والطباعة</span></div>
        </nav>

        <!-- S1 -->
        <section class="scr active" id="s1">
            <div class="card">
                <div class="ct"><i data-lucide="file-up" class="lucide-icon"></i> رفع تقرير SS05 جدول المتدرب (CSV)
                </div>
                <div class="uz" id="UZ" onclick="document.getElementById('FI').click()">
                    <span class="uzi"><i data-lucide="upload-cloud"
                            style="width:3rem;height:3rem;stroke:var(--pri)"></i></span>
                    <div class="uzt">اضغط هنا لاختيار ملف CSV</div>
                    <div class="uzh">أو اسحب الملف وأفلته في هذه المنطقة</div>
                </div>
                <input type="file" accept=".csv" id="FI" style="display:none">
                <div id="US" style="display:none">
                    <div class="stb">
                        <div class="sti">
                            <div class="stv" id="sT">0</div>
                            <div class="stl">متدرب</div>
                        </div>
                        <div class="sti">
                            <div class="stv" id="sR">0</div>
                            <div class="stl">محاضرة</div>
                        </div>
                        <div class="sti">
                            <div class="stv" id="sM">--</div>
                            <div class="stl">أول بداية</div>
                        </div>
                        <div class="sti">
                            <div class="stv" id="sX">0</div>
                            <div class="stl">أقصى محاضرة</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ab">
                <div></div><button class="btn bp" id="b2" disabled onclick="goTo(2)">التالي — الإعدادات <i
                        data-lucide="arrow-left" style="width:16px;height:16px"></i></button>
            </div>
        </section>

        <!-- S2 -->
        <section class="scr" id="s2">
            <div class="card">
                <div class="ct"><i data-lucide="clock" class="lucide-icon"></i> أوقات محاضرات رمضان</div>
                <div class="sg" id="SG"></div>
                <div style="margin-top:12px;text-align:center"><button class="btn bo bsm" onclick="resetS()"><i
                            data-lucide="rotate-ccw" style="width:14px;height:14px"></i> إعادة
                        للقيم الافتراضية</button></div>
            </div>
            <!-- Mismatched times card -->
            <div class="card" id="mismatchCard" style="display:none;margin-top:16px">
                <div class="ct" style="color:var(--acc)"><i data-lucide="alert-triangle" class="lucide-icon"
                        style="stroke:var(--acc)"></i> أوقات غير متطابقة مع الفترات المحسوبة</div>
                <p id="mismatchDesc" style="font-size:.82rem;color:var(--mut);margin-bottom:10px">السجلات التالية لا
                    تتطابق أوقاتها مع
                    الفترات الأصلية المحسوبة «قبل رمضان» (بداية مختلفة أو مدة ليست من مضاعفات 50 دقيقة):</p>
                <div id="mismatchTable" style="overflow-x:auto"></div>
            </div>
            <div class="ab"><button class="btn bo" onclick="goTo(1)"><i data-lucide="arrow-right"
                        style="width:16px;height:16px"></i> السابق</button><button class="btn bp"
                    onclick="goTo(3)">التالي — المعاينة <i data-lucide="arrow-left"
                        style="width:16px;height:16px"></i></button></div>
        </section>

        <!-- S3 -->
        <section class="scr" id="s3">
            <div class="g3" style="display:grid;grid-template-columns:280px 1fr;gap:20px">
                <div class="card" style="align-self:start">
                    <div class="ct"><i data-lucide="users" class="lucide-icon"></i> المتدربون</div>
                    <div class="sbx"><span class="sic"><i data-lucide="search"
                                style="width:18px;height:18px;stroke:var(--mut)"></i></span><input type="text" id="SI"
                            placeholder="بحث بالاسم أو الرقم..." oninput="filt()"></div>
                    <div class="tl" id="TL"></div>
                </div>
                <div>
                    <div class="unit-edit-wrap">
                        <label><i data-lucide="building-2" style="width:18px;height:18px;stroke:var(--pri)"></i> اسم
                            الوحدة التدريبية</label>
                        <input type="text" id="unitNameInput" placeholder="اسم الوحدة التدريبية..."
                            oninput="onUnitNameChange()">
                    </div>
                    <div class="controls-bar">
                        <div class="ctrl-group">
                            <label><i data-lucide="arrow-up-down" style="width:15px;height:15px;stroke:var(--pri)"></i>
                                الترتيب</label>
                            <select id="sortOrder" onchange="onSortChange()">
                                <option value="tid">حسب الرقم التدريبي</option>
                                <option value="name">حسب الاسم</option>
                            </select>
                        </div>
                        <div class="ctrl-group">
                            <label><i data-lucide="user" style="width:15px;height:15px;stroke:var(--pri)"></i>
                                نوع الوحدة</label>
                            <select id="genderType" onchange="onGenderChange()">
                                <option value="male">بنين</option>
                                <option value="female">بنات</option>
                            </select>
                        </div>
                        <div class="ctrl-group">
                            <label><i data-lucide="clock" style="width:15px;height:15px;stroke:var(--pri)"></i>
                                الوقت</label>
                            <select id="timeFormatSel" onchange="onTimeFormatChange()">
                                <option value="24h">24 ساعة</option>
                                <option value="12h">12 ساعة (ص/م)</option>
                            </select>
                        </div>
                    </div>
                    <div class="notes-section" id="notesSection">
                        <div class="notes-header">
                            <label><i data-lucide="message-square" style="width:15px;height:15px;stroke:var(--pri)"></i>
                                الملاحظات</label>
                            <button class="note-add-btn" onclick="addNote()" title="إضافة ملاحظة جديدة">+</button>
                        </div>
                        <div id="noteInputs"></div>
                    </div>
                    <div class="card">
                        <div class="ct"><i data-lucide="eye" class="lucide-icon"></i> معاينة الجدول</div>
                        <div id="PF"
                            style="background:#fff;border:1px solid var(--bd);border-radius:10px;padding:20px;min-height:200px;direction:rtl">
                            <div
                                style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;color:var(--mut)">
                                <span style="opacity:.3;margin-bottom:12px"><i data-lucide="clipboard-list"
                                        style="width:3rem;height:3rem;stroke:var(--mut)"></i></span>اختر متدرباً لمعاينة
                                جدوله
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="ct"><i data-lucide="printer" class="lucide-icon"></i> الطباعة</div>
                        <div class="ab" style="margin-top:0">
                            <button class="btn ba" id="bPA" onclick="printAll()"><i data-lucide="printer"
                                    style="width:16px;height:16px"></i> طباعة جميع الجداول</button>
                            <button class="btn bo" id="bPS" onclick="printOne()" disabled><i data-lucide="printer"
                                    style="width:16px;height:16px"></i> طباعة الجدول
                                المحدد</button>
                        </div>
                        <div class="print-notice">
                            <i data-lucide="info" style="width:18px;height:18px;stroke:var(--acc);margin-top:2px"></i>
                            <div>
                                <strong>تنبيه هام:</strong> لضمان ظهور خلفيات الجداول والتنسيقات بشكل سليم؛ عند الطباعة
                                (من خيار الإعدادات الإضافية) يرجى تفعيل خيار <b>«رسومات الخلفية» (Background
                                    Graphics) أو (Print backgrounds)</b>.
                            </div>
                        </div>
                        <div class="ab" style="margin-top:12px">
                            <button class="btn bo" id="bExport" onclick="exportExcel()" style="flex:1"><i
                                    data-lucide="download" style="width:16px;height:16px"></i> تصدير تقرير الجداول
                                (Excel CSV)</button>
                            <button class="btn bo" id="bImgExport" onclick="openRamadanCard()" style="flex:1"><i
                                    data-lucide="image" style="width:16px;height:16px"></i> صورة أوقات
                                رمضان</button>
                        </div>
                        <div class="pw" id="PW">
                            <div class="pb">
                                <div class="pfl" id="PFL"></div>
                            </div>
                            <div class="ptx" id="PTX"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="ab"><button class="btn bo" onclick="goTo(2)"><i data-lucide="arrow-right"
                        style="width:16px;height:16px"></i> السابق</button></div>
        </section>
    </div>

    <!-- ═══════════ RAMADAN CARD MODAL ═══════════ -->
    <div id="ramCardModal"
        style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);overflow-y:auto;direction:rtl">
        <div style="max-width:880px;margin:24px auto;padding:20px;display:flex;flex-direction:column;gap:16px">
            <!-- Top bar -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                <h2 style="color:#fff;font-size:1.2rem;margin:0"><i data-lucide="image"
                        style="width:20px;height:20px;vertical-align:middle;margin-left:6px"></i> صورة أوقات رمضان</h2>
                <button onclick="closeRamadanCard()"
                    style="background:rgba(255,255,255,.15);border:none;color:#fff;width:36px;height:36px;border-radius:50%;font-size:18px;cursor:pointer;transition:.2s"
                    onmouseover="this.style.background='rgba(255,255,255,.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,.15)'">✕</button>
            </div>
            <!-- Controls -->
            <div
                style="background:var(--bg);border-radius:12px;padding:16px;display:flex;flex-wrap:wrap;gap:12px;align-items:end">
                <div style="display:flex;flex-direction:column;gap:4px">
                    <label style="font-size:.78rem;color:var(--mut)">عدد المحاضرات</label>
                    <select id="rcLectureCount" onchange="refreshRamadanPreview()"
                        style="padding:6px 10px;border:1.5px solid var(--bd);border-radius:6px;font-size:.85rem;background:#fff"></select>
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;min-width:160px">
                    <label style="font-size:.78rem;color:var(--mut)">الفصل التدريبي</label>
                    <input type="text" id="rcSemester" onchange="refreshRamadanPreview()"
                        placeholder="مثال: الفصل الثاني 1446هـ"
                        style="padding:6px 10px;border:1.5px solid var(--bd);border-radius:6px;font-size:.85rem"
                        dir="rtl">
                </div>
                <div style="display:flex;flex-direction:column;gap:4px;flex:1;min-width:180px" id="rcBreaksWrap"></div>
                <div style="display:flex;flex-direction:column;gap:4px;flex:1;min-width:200px">
                    <label style="font-size:.78rem;color:var(--mut)">ملاحظات</label>
                    <input type="text" id="rcNotes" onchange="refreshRamadanPreview()" placeholder=""
                        style="padding:6px 10px;border:1.5px solid var(--bd);border-radius:6px;font-size:.85rem"
                        dir="rtl">
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn ba" onclick="downloadRamadanCard()" style="padding:6px 16px"><i
                            data-lucide="download" style="width:15px;height:15px"></i> تصدير صورة</button>
                    <button class="btn bo" onclick="printRamadanCard()" style="padding:6px 16px"><i
                            data-lucide="printer" style="width:15px;height:15px"></i> طباعة</button>
                </div>
            </div>
            <!-- Canvas Preview -->
            <div style="background:#1a1a2e;border-radius:16px;padding:20px;display:flex;justify-content:center">
                <canvas id="rcCanvas" style="max-width:100%;border-radius:12px"></canvas>
            </div>
        </div>
    </div>

    <!-- Hidden print area -->
    <div id="printArea"></div>

    <script>
        /* @license
        Papa Parse
        v5.4.1
        https://github.com/mholt/PapaParse
        License: MIT
        */
        !function (e, t) { "function" == typeof define && define.amd ? define([], t) : "object" == typeof module && "undefined" != typeof exports ? module.exports = t() : e.Papa = t() }(this, function s() { "use strict"; var f = "undefined" != typeof self ? self : "undefined" != typeof window ? window : void 0 !== f ? f : {}; var n = !f.document && !!f.postMessage, o = f.IS_PAPA_WORKER || !1, a = {}, u = 0, b = { parse: function (e, t) { var r = (t = t || {}).dynamicTyping || !1; J(r) && (t.dynamicTypingFunction = r, r = {}); if (t.dynamicTyping = r, t.transform = !!J(t.transform) && t.transform, t.worker && b.WORKERS_SUPPORTED) { var i = function () { if (!b.WORKERS_SUPPORTED) return !1; var e = (r = f.URL || f.webkitURL || null, i = s.toString(), b.BLOB_URL || (b.BLOB_URL = r.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ", "(", i, ")();"], { type: "text/javascript" })))), t = new f.Worker(e); var r, i; return t.onmessage = _, t.id = u++, a[t.id] = t }(); return i.userStep = t.step, i.userChunk = t.chunk, i.userComplete = t.complete, i.userError = t.error, t.step = J(t.step), t.chunk = J(t.chunk), t.complete = J(t.complete), t.error = J(t.error), delete t.worker, void i.postMessage({ input: e, config: t, workerId: i.id }) } var n = null; b.NODE_STREAM_INPUT, "string" == typeof e ? (e = function (e) { if (65279 === e.charCodeAt(0)) return e.slice(1); return e }(e), n = t.download ? new l(t) : new p(t)) : !0 === e.readable && J(e.read) && J(e.on) ? n = new g(t) : (f.File && e instanceof File || e instanceof Object) && (n = new c(t)); return n.stream(e) }, unparse: function (e, t) { var n = !1, _ = !0, m = ",", y = "\r\n", s = '"', a = s + s, r = !1, i = null, o = !1; !function () { if ("object" != typeof t) return; "string" != typeof t.delimiter || b.BAD_DELIMITERS.filter(function (e) { return -1 !== t.delimiter.indexOf(e) }).length || (m = t.delimiter); ("boolean" == typeof t.quotes || "function" == typeof t.quotes || Array.isArray(t.quotes)) && (n = t.quotes); "boolean" != typeof t.skipEmptyLines && "string" != typeof t.skipEmptyLines || (r = t.skipEmptyLines); "string" == typeof t.newline && (y = t.newline); "string" == typeof t.quoteChar && (s = t.quoteChar); "boolean" == typeof t.header && (_ = t.header); if (Array.isArray(t.columns)) { if (0 === t.columns.length) throw new Error("Option columns is empty"); i = t.columns } void 0 !== t.escapeChar && (a = t.escapeChar + s); ("boolean" == typeof t.escapeFormulae || t.escapeFormulae instanceof RegExp) && (o = t.escapeFormulae instanceof RegExp ? t.escapeFormulae : /^[=+\-@\t\r].*$/) }(); var u = new RegExp(Q(s), "g"); "string" == typeof e && (e = JSON.parse(e)); if (Array.isArray(e)) { if (!e.length || Array.isArray(e[0])) return h(null, e, r); if ("object" == typeof e[0]) return h(i || Object.keys(e[0]), e, r) } else if ("object" == typeof e) return "string" == typeof e.data && (e.data = JSON.parse(e.data)), Array.isArray(e.data) && (e.fields || (e.fields = e.meta && e.meta.fields || i), e.fields || (e.fields = Array.isArray(e.data[0]) ? e.fields : "object" == typeof e.data[0] ? Object.keys(e.data[0]) : []), Array.isArray(e.data[0]) || "object" == typeof e.data[0] || (e.data = [e.data])), h(e.fields || [], e.data || [], r); throw new Error("Unable to serialize unrecognized input"); function h(e, t, r) { var i = ""; "string" == typeof e && (e = JSON.parse(e)), "string" == typeof t && (t = JSON.parse(t)); var n = Array.isArray(e) && 0 < e.length, s = !Array.isArray(t[0]); if (n && _) { for (var a = 0; a < e.length; a++)0 < a && (i += m), i += v(e[a], a); 0 < t.length && (i += y) } for (var o = 0; o < t.length; o++) { var u = n ? e.length : t[o].length, h = !1, f = n ? 0 === Object.keys(t[o]).length : 0 === t[o].length; if (r && !n && (h = "greedy" === r ? "" === t[o].join("").trim() : 1 === t[o].length && 0 === t[o][0].length), "greedy" === r && n) { for (var d = [], l = 0; l < u; l++) { var c = s ? e[l] : l; d.push(t[o][c]) } h = "" === d.join("").trim() } if (!h) { for (var p = 0; p < u; p++) { 0 < p && !f && (i += m); var g = n && s ? e[p] : p; i += v(t[o][g], p) } o < t.length - 1 && (!r || 0 < u && !f) && (i += y) } } return i } function v(e, t) { if (null == e) return ""; if (e.constructor === Date) return JSON.stringify(e).slice(1, 25); var r = !1; o && "string" == typeof e && o.test(e) && (e = "'" + e, r = !0); var i = e.toString().replace(u, a); return (r = r || !0 === n || "function" == typeof n && n(e, t) || Array.isArray(n) && n[t] || function (e, t) { for (var r = 0; r < t.length; r++)if (-1 < e.indexOf(t[r])) return !0; return !1 }(i, b.BAD_DELIMITERS) || -1 < i.indexOf(m) || " " === i.charAt(0) || " " === i.charAt(i.length - 1)) ? s + i + s : i } } }; if (b.RECORD_SEP = String.fromCharCode(30), b.UNIT_SEP = String.fromCharCode(31), b.BYTE_ORDER_MARK = "\ufeff", b.BAD_DELIMITERS = ["\r", "\n", '"', b.BYTE_ORDER_MARK], b.WORKERS_SUPPORTED = !n && !!f.Worker, b.NODE_STREAM_INPUT = 1, b.LocalChunkSize = 10485760, b.RemoteChunkSize = 5242880, b.DefaultDelimiter = ",", b.Parser = E, b.ParserHandle = r, b.NetworkStreamer = l, b.FileStreamer = c, b.StringStreamer = p, b.ReadableStreamStreamer = g, f.jQuery) { var d = f.jQuery; d.fn.parse = function (o) { var r = o.config || {}, u = []; return this.each(function (e) { if (!("INPUT" === d(this).prop("tagName").toUpperCase() && "file" === d(this).attr("type").toLowerCase() && f.FileReader) || !this.files || 0 === this.files.length) return !0; for (var t = 0; t < this.files.length; t++)u.push({ file: this.files[t], inputElem: this, instanceConfig: d.extend({}, r) }) }), e(), this; function e() { if (0 !== u.length) { var e, t, r, i, n = u[0]; if (J(o.before)) { var s = o.before(n.file, n.inputElem); if ("object" == typeof s) { if ("abort" === s.action) return e = "AbortError", t = n.file, r = n.inputElem, i = s.reason, void (J(o.error) && o.error({ name: e }, t, r, i)); if ("skip" === s.action) return void h(); "object" == typeof s.config && (n.instanceConfig = d.extend(n.instanceConfig, s.config)) } else if ("skip" === s) return void h() } var a = n.instanceConfig.complete; n.instanceConfig.complete = function (e) { J(a) && a(e, n.file, n.inputElem), h() }, b.parse(n.file, n.instanceConfig) } else J(o.complete) && o.complete() } function h() { u.splice(0, 1), e() } } } function h(e) { this._handle = null, this._finished = !1, this._completed = !1, this._halted = !1, this._input = null, this._baseIndex = 0, this._partialLine = "", this._rowCount = 0, this._start = 0, this._nextChunk = null, this.isFirstChunk = !0, this._completeResults = { data: [], errors: [], meta: {} }, function (e) { var t = w(e); t.chunkSize = parseInt(t.chunkSize), e.step || e.chunk || (t.chunkSize = null); this._handle = new r(t), (this._handle.streamer = this)._config = t }.call(this, e), this.parseChunk = function (e, t) { if (this.isFirstChunk && J(this._config.beforeFirstChunk)) { var r = this._config.beforeFirstChunk(e); void 0 !== r && (e = r) } this.isFirstChunk = !1, this._halted = !1; var i = this._partialLine + e; this._partialLine = ""; var n = this._handle.parse(i, this._baseIndex, !this._finished); if (!this._handle.paused() && !this._handle.aborted()) { var s = n.meta.cursor; this._finished || (this._partialLine = i.substring(s - this._baseIndex), this._baseIndex = s), n && n.data && (this._rowCount += n.data.length); var a = this._finished || this._config.preview && this._rowCount >= this._config.preview; if (o) f.postMessage({ results: n, workerId: b.WORKER_ID, finished: a }); else if (J(this._config.chunk) && !t) { if (this._config.chunk(n, this._handle), this._handle.paused() || this._handle.aborted()) return void (this._halted = !0); n = void 0, this._completeResults = void 0 } return this._config.step || this._config.chunk || (this._completeResults.data = this._completeResults.data.concat(n.data), this._completeResults.errors = this._completeResults.errors.concat(n.errors), this._completeResults.meta = n.meta), this._completed || !a || !J(this._config.complete) || n && n.meta.aborted || (this._config.complete(this._completeResults, this._input), this._completed = !0), a || n && n.meta.paused || this._nextChunk(), n } this._halted = !0 }, this._sendError = function (e) { J(this._config.error) ? this._config.error(e) : o && this._config.error && f.postMessage({ workerId: b.WORKER_ID, error: e, finished: !1 }) } } function l(e) { var i; (e = e || {}).chunkSize || (e.chunkSize = b.RemoteChunkSize), h.call(this, e), this._nextChunk = n ? function () { this._readChunk(), this._chunkLoaded() } : function () { this._readChunk() }, this.stream = function (e) { this._input = e, this._nextChunk() }, this._readChunk = function () { if (this._finished) this._chunkLoaded(); else { if (i = new XMLHttpRequest, this._config.withCredentials && (i.withCredentials = this._config.withCredentials), n || (i.onload = v(this._chunkLoaded, this), i.onerror = v(this._chunkError, this)), i.open(this._config.downloadRequestBody ? "POST" : "GET", this._input, !n), this._config.downloadRequestHeaders) { var e = this._config.downloadRequestHeaders; for (var t in e) i.setRequestHeader(t, e[t]) } if (this._config.chunkSize) { var r = this._start + this._config.chunkSize - 1; i.setRequestHeader("Range", "bytes=" + this._start + "-" + r) } try { i.send(this._config.downloadRequestBody) } catch (e) { this._chunkError(e.message) } n && 0 === i.status && this._chunkError() } }, this._chunkLoaded = function () { 4 === i.readyState && (i.status < 200 || 400 <= i.status ? this._chunkError() : (this._start += this._config.chunkSize ? this._config.chunkSize : i.responseText.length, this._finished = !this._config.chunkSize || this._start >= function (e) { var t = e.getResponseHeader("Content-Range"); if (null === t) return -1; return parseInt(t.substring(t.lastIndexOf("/") + 1)) }(i), this.parseChunk(i.responseText))) }, this._chunkError = function (e) { var t = i.statusText || e; this._sendError(new Error(t)) } } function c(e) { var i, n; (e = e || {}).chunkSize || (e.chunkSize = b.LocalChunkSize), h.call(this, e); var s = "undefined" != typeof FileReader; this.stream = function (e) { this._input = e, n = e.slice || e.webkitSlice || e.mozSlice, s ? ((i = new FileReader).onload = v(this._chunkLoaded, this), i.onerror = v(this._chunkError, this)) : i = new FileReaderSync, this._nextChunk() }, this._nextChunk = function () { this._finished || this._config.preview && !(this._rowCount < this._config.preview) || this._readChunk() }, this._readChunk = function () { var e = this._input; if (this._config.chunkSize) { var t = Math.min(this._start + this._config.chunkSize, this._input.size); e = n.call(e, this._start, t) } var r = i.readAsText(e, this._config.encoding); s || this._chunkLoaded({ target: { result: r } }) }, this._chunkLoaded = function (e) { this._start += this._config.chunkSize, this._finished = !this._config.chunkSize || this._start >= this._input.size, this.parseChunk(e.target.result) }, this._chunkError = function () { this._sendError(i.error) } } function p(e) { var r; h.call(this, e = e || {}), this.stream = function (e) { return r = e, this._nextChunk() }, this._nextChunk = function () { if (!this._finished) { var e, t = this._config.chunkSize; return t ? (e = r.substring(0, t), r = r.substring(t)) : (e = r, r = ""), this._finished = !r, this.parseChunk(e) } } } function g(e) { h.call(this, e = e || {}); var t = [], r = !0, i = !1; this.pause = function () { h.prototype.pause.apply(this, arguments), this._input.pause() }, this.resume = function () { h.prototype.resume.apply(this, arguments), this._input.resume() }, this.stream = function (e) { this._input = e, this._input.on("data", this._streamData), this._input.on("end", this._streamEnd), this._input.on("error", this._streamError) }, this._checkIsFinished = function () { i && 1 === t.length && (this._finished = !0) }, this._nextChunk = function () { this._checkIsFinished(), t.length ? this.parseChunk(t.shift()) : r = !0 }, this._streamData = v(function (e) { try { t.push("string" == typeof e ? e : e.toString(this._config.encoding)), r && (r = !1, this._checkIsFinished(), this.parseChunk(t.shift())) } catch (e) { this._streamError(e) } }, this), this._streamError = v(function (e) { this._streamCleanUp(), this._sendError(e) }, this), this._streamEnd = v(function () { this._streamCleanUp(), i = !0, this._streamData("") }, this), this._streamCleanUp = v(function () { this._input.removeListener("data", this._streamData), this._input.removeListener("end", this._streamEnd), this._input.removeListener("error", this._streamError) }, this) } function r(m) { var a, o, u, i = Math.pow(2, 53), n = -i, s = /^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/, h = /^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/, t = this, r = 0, f = 0, d = !1, e = !1, l = [], c = { data: [], errors: [], meta: {} }; if (J(m.step)) { var p = m.step; m.step = function (e) { if (c = e, _()) g(); else { if (g(), 0 === c.data.length) return; r += e.data.length, m.preview && r > m.preview ? o.abort() : (c.data = c.data[0], p(c, t)) } } } function y(e) { return "greedy" === m.skipEmptyLines ? "" === e.join("").trim() : 1 === e.length && 0 === e[0].length } function g() { return c && u && (k("Delimiter", "UndetectableDelimiter", "Unable to auto-detect delimiting character; defaulted to '" + b.DefaultDelimiter + "'"), u = !1), m.skipEmptyLines && (c.data = c.data.filter(function (e) { return !y(e) })), _() && function () { if (!c) return; function e(e, t) { J(m.transformHeader) && (e = m.transformHeader(e, t)), l.push(e) } if (Array.isArray(c.data[0])) { for (var t = 0; _() && t < c.data.length; t++)c.data[t].forEach(e); c.data.splice(0, 1) } else c.data.forEach(e) }(), function () { if (!c || !m.header && !m.dynamicTyping && !m.transform) return c; function e(e, t) { var r, i = m.header ? {} : []; for (r = 0; r < e.length; r++) { var n = r, s = e[r]; m.header && (n = r >= l.length ? "__parsed_extra" : l[r]), m.transform && (s = m.transform(s, n)), s = v(n, s), "__parsed_extra" === n ? (i[n] = i[n] || [], i[n].push(s)) : i[n] = s } return m.header && (r > l.length ? k("FieldMismatch", "TooManyFields", "Too many fields: expected " + l.length + " fields but parsed " + r, f + t) : r < l.length && k("FieldMismatch", "TooFewFields", "Too few fields: expected " + l.length + " fields but parsed " + r, f + t)), i } var t = 1; !c.data.length || Array.isArray(c.data[0]) ? (c.data = c.data.map(e), t = c.data.length) : c.data = e(c.data, 0); m.header && c.meta && (c.meta.fields = l); return f += t, c }() } function _() { return m.header && 0 === l.length } function v(e, t) { return r = e, m.dynamicTypingFunction && void 0 === m.dynamicTyping[r] && (m.dynamicTyping[r] = m.dynamicTypingFunction(r)), !0 === (m.dynamicTyping[r] || m.dynamicTyping) ? "true" === t || "TRUE" === t || "false" !== t && "FALSE" !== t && (function (e) { if (s.test(e)) { var t = parseFloat(e); if (n < t && t < i) return !0 } return !1 }(t) ? parseFloat(t) : h.test(t) ? new Date(t) : "" === t ? null : t) : t; var r } function k(e, t, r, i) { var n = { type: e, code: t, message: r }; void 0 !== i && (n.row = i), c.errors.push(n) } this.parse = function (e, t, r) { var i = m.quoteChar || '"'; if (m.newline || (m.newline = function (e, t) { e = e.substring(0, 1048576); var r = new RegExp(Q(t) + "([^]*?)" + Q(t), "gm"), i = (e = e.replace(r, "")).split("\r"), n = e.split("\n"), s = 1 < n.length && n[0].length < i[0].length; if (1 === i.length || s) return "\n"; for (var a = 0, o = 0; o < i.length; o++)"\n" === i[o][0] && a++; return a >= i.length / 2 ? "\r\n" : "\r" }(e, i)), u = !1, m.delimiter) J(m.delimiter) && (m.delimiter = m.delimiter(e), c.meta.delimiter = m.delimiter); else { var n = function (e, t, r, i, n) { var s, a, o, u; n = n || [",", "\t", "|", ";", b.RECORD_SEP, b.UNIT_SEP]; for (var h = 0; h < n.length; h++) { var f = n[h], d = 0, l = 0, c = 0; o = void 0; for (var p = new E({ comments: i, delimiter: f, newline: t, preview: 10 }).parse(e), g = 0; g < p.data.length; g++)if (r && y(p.data[g])) c++; else { var _ = p.data[g].length; l += _, void 0 !== o ? 0 < _ && (d += Math.abs(_ - o), o = _) : o = _ } 0 < p.data.length && (l /= p.data.length - c), (void 0 === a || d <= a) && (void 0 === u || u < l) && 1.99 < l && (a = d, s = f, u = l) } return { successful: !!(m.delimiter = s), bestDelimiter: s } }(e, m.newline, m.skipEmptyLines, m.comments, m.delimitersToGuess); n.successful ? m.delimiter = n.bestDelimiter : (u = !0, m.delimiter = b.DefaultDelimiter), c.meta.delimiter = m.delimiter } var s = w(m); return m.preview && m.header && s.preview++, a = e, o = new E(s), c = o.parse(a, t, r), g(), d ? { meta: { paused: !0 } } : c || { meta: { paused: !1 } } }, this.paused = function () { return d }, this.pause = function () { d = !0, o.abort(), a = J(m.chunk) ? "" : a.substring(o.getCharIndex()) }, this.resume = function () { t.streamer._halted ? (d = !1, t.streamer.parseChunk(a, !0)) : setTimeout(t.resume, 3) }, this.aborted = function () { return e }, this.abort = function () { e = !0, o.abort(), c.meta.aborted = !0, J(m.complete) && m.complete(c), a = "" } } function Q(e) { return e.replace(/[.*+?^${}()|[\]\\]/g, "\\$&") } function E(j) { var z, M = (j = j || {}).delimiter, P = j.newline, U = j.comments, q = j.step, N = j.preview, B = j.fastMode, K = z = void 0 === j.quoteChar || null === j.quoteChar ? '"' : j.quoteChar; if (void 0 !== j.escapeChar && (K = j.escapeChar), ("string" != typeof M || -1 < b.BAD_DELIMITERS.indexOf(M)) && (M = ","), U === M) throw new Error("Comment character same as delimiter"); !0 === U ? U = "#" : ("string" != typeof U || -1 < b.BAD_DELIMITERS.indexOf(U)) && (U = !1), "\n" !== P && "\r" !== P && "\r\n" !== P && (P = "\n"); var W = 0, H = !1; this.parse = function (i, t, r) { if ("string" != typeof i) throw new Error("Input must be a string"); var n = i.length, e = M.length, s = P.length, a = U.length, o = J(q), u = [], h = [], f = [], d = W = 0; if (!i) return L(); if (j.header && !t) { var l = i.split(P)[0].split(M), c = [], p = {}, g = !1; for (var _ in l) { var m = l[_]; J(j.transformHeader) && (m = j.transformHeader(m, _)); var y = m, v = p[m] || 0; for (0 < v && (g = !0, y = m + "_" + v), p[m] = v + 1; c.includes(y);)y = y + "_" + v; c.push(y) } if (g) { var k = i.split(P); k[0] = c.join(M), i = k.join(P) } } if (B || !1 !== B && -1 === i.indexOf(z)) { for (var b = i.split(P), E = 0; E < b.length; E++) { if (f = b[E], W += f.length, E !== b.length - 1) W += P.length; else if (r) return L(); if (!U || f.substring(0, a) !== U) { if (o) { if (u = [], I(f.split(M)), F(), H) return L() } else I(f.split(M)); if (N && N <= E) return u = u.slice(0, N), L(!0) } } return L() } for (var w = i.indexOf(M, W), R = i.indexOf(P, W), C = new RegExp(Q(K) + Q(z), "g"), S = i.indexOf(z, W); ;)if (i[W] !== z) if (U && 0 === f.length && i.substring(W, W + a) === U) { if (-1 === R) return L(); W = R + s, R = i.indexOf(P, W), w = i.indexOf(M, W) } else if (-1 !== w && (w < R || -1 === R)) f.push(i.substring(W, w)), W = w + e, w = i.indexOf(M, W); else { if (-1 === R) break; if (f.push(i.substring(W, R)), D(R + s), o && (F(), H)) return L(); if (N && u.length >= N) return L(!0) } else for (S = W, W++; ;) { if (-1 === (S = i.indexOf(z, S + 1))) return r || h.push({ type: "Quotes", code: "MissingQuotes", message: "Quoted field unterminated", row: u.length, index: W }), T(); if (S === n - 1) return T(i.substring(W, S).replace(C, z)); if (z !== K || i[S + 1] !== K) { if (z === K || 0 === S || i[S - 1] !== K) { -1 !== w && w < S + 1 && (w = i.indexOf(M, S + 1)), -1 !== R && R < S + 1 && (R = i.indexOf(P, S + 1)); var O = A(-1 === R ? w : Math.min(w, R)); if (i.substr(S + 1 + O, e) === M) { f.push(i.substring(W, S).replace(C, z)), i[W = S + 1 + O + e] !== z && (S = i.indexOf(z, W)), w = i.indexOf(M, W), R = i.indexOf(P, W); break } var x = A(R); if (i.substring(S + 1 + x, S + 1 + x + s) === P) { if (f.push(i.substring(W, S).replace(C, z)), D(S + 1 + x + s), w = i.indexOf(M, W), S = i.indexOf(z, W), o && (F(), H)) return L(); if (N && u.length >= N) return L(!0); break } h.push({ type: "Quotes", code: "InvalidQuotes", message: "Trailing quote on quoted field is malformed", row: u.length, index: W }), S++ } } else S++ } return T(); function I(e) { u.push(e), d = W } function A(e) { var t = 0; if (-1 !== e) { var r = i.substring(S + 1, e); r && "" === r.trim() && (t = r.length) } return t } function T(e) { return r || (void 0 === e && (e = i.substring(W)), f.push(e), W = n, I(f), o && F()), L() } function D(e) { W = e, I(f), f = [], R = i.indexOf(P, W) } function L(e) { return { data: u, errors: h, meta: { delimiter: M, linebreak: P, aborted: H, truncated: !!e, cursor: d + (t || 0) } } } function F() { q(L()), u = [], h = [] } }, this.abort = function () { H = !0 }, this.getCharIndex = function () { return W } } function _(e) { var t = e.data, r = a[t.workerId], i = !1; if (t.error) r.userError(t.error, t.file); else if (t.results && t.results.data) { var n = { abort: function () { i = !0, m(t.workerId, { data: [], errors: [], meta: { aborted: !0 } }) }, pause: y, resume: y }; if (J(r.userStep)) { for (var s = 0; s < t.results.data.length && (r.userStep({ data: t.results.data[s], errors: t.results.errors, meta: t.results.meta }, n), !i); s++); delete t.results } else J(r.userChunk) && (r.userChunk(t.results, n, t.file), delete t.results) } t.finished && !i && m(t.workerId, t.results) } function m(e, t) { var r = a[e]; J(r.userComplete) && r.userComplete(t), r.terminate(), delete a[e] } function y() { throw new Error("Not implemented.") } function w(e) { if ("object" != typeof e || null === e) return e; var t = Array.isArray(e) ? [] : {}; for (var r in e) t[r] = w(e[r]); return t } function v(e, t) { return function () { e.apply(t, arguments) } } function J(e) { return "function" == typeof e } return o && (f.onmessage = function (e) { var t = e.data; void 0 === b.WORKER_ID && t && (b.WORKER_ID = t.workerId); if ("string" == typeof t.input) f.postMessage({ workerId: b.WORKER_ID, results: b.parse(t.input, t.config), finished: !0 }); else if (f.File && t.input instanceof File || t.input instanceof Object) { var r = b.parse(t.input, t.config); r && f.postMessage({ workerId: b.WORKER_ID, results: r, finished: !0 }) } }), (l.prototype = Object.create(h.prototype)).constructor = l, (c.prototype = Object.create(h.prototype)).constructor = c, (p.prototype = Object.create(p.prototype)).constructor = p, (g.prototype = Object.create(h.prototype)).constructor = g, b });</script>
    <script>
        // ══════════════════════════════════════════════════════════
        //  STATE & CONFIG
        // ══════════════════════════════════════════════════════════
        const A = { recs: [], trainees: new Map(), gMin: Infinity, maxSlot: 0, selId: null, logo: 'logo.png', oldSlots: [], oldBreaks: [] };
        const LECTURE_DUR = 35; // Ramadan lecture duration in minutes
        const DEFAULT_BREAKS = [0, 5, 0, 10, 0, 5, 0, 5, 0]; // breaks AFTER lecture index 0..8
        const DEFAULT_START = 10 * 60 + 15; // 10:15 default first lecture start
        let ramadanStart = DEFAULT_START; // current first lecture start (in minutes)
        let ramadanBreaks = [...DEFAULT_BREAKS]; // current breaks (editable)
        let customUnitName = ''; // user-editable unit name (from CSV, overridable)
        let sortOrder = 'tid'; // 'tid' or 'name'
        let genderType = 'male'; // 'male' or 'female'
        const DEFAULT_NOTE = 'احترامك لمواعيد تدريبك يعكس رقيّ شخصيتك المهنية، وكل عام وأنتم بخير،،،';
        let schedNotes = [DEFAULT_NOTE]; // array of user notes for all schedules
        let timeFormat = '12h'; // '24h' or '12h' — time display in trainee schedules (12h default)

        // ═══ MANUAL EDITS STORAGE ═══
        // Stores user manual edits so they persist across file re-uploads
        const userEdits = {
            hasEdits: false,          // true if user made ANY manual edit
            ramadanStart: null,       // manually edited Ramadan start time
            ramadanBreaks: null,      // manually edited Ramadan breaks
            oldSlotStarts: null,      // manually edited old slot start times [array of minutes]
            customUnitName: null,     // manually edited college/unit name
            schedNotes: null,         // manually edited notes array
            timeFormat: null          // manually edited time format preference
        };

        // Save current edits state
        function saveUserEdits() {
            userEdits.ramadanStart = ramadanStart;
            userEdits.ramadanBreaks = [...ramadanBreaks];
            userEdits.customUnitName = customUnitName;
            userEdits.schedNotes = [...schedNotes];
            userEdits.timeFormat = timeFormat;
            // Save old slot starts if they exist
            if (A.oldSlots && A.oldSlots.length > 0) {
                userEdits.oldSlotStarts = A.oldSlots.map(s => s.s);
            }
            userEdits.hasEdits = true;
        }

        // Restore saved edits after new file upload
        function restoreUserEdits() {
            if (!userEdits.hasEdits) return;
            // Restore Ramadan times
            if (userEdits.ramadanStart !== null) ramadanStart = userEdits.ramadanStart;
            if (userEdits.ramadanBreaks !== null) ramadanBreaks = [...userEdits.ramadanBreaks];
            computeRS();
            // Restore old slot starts (keep the new fromCSV/nearbyTimes but apply user's start edits)
            if (userEdits.oldSlotStarts !== null && A.oldSlots.length > 0) {
                const maxIdx = Math.min(userEdits.oldSlotStarts.length, A.oldSlots.length);
                for (let i = 0; i < maxIdx; i++) {
                    A.oldSlots[i].s = userEdits.oldSlotStarts[i];
                    A.oldSlots[i].e = userEdits.oldSlotStarts[i] + OLD_DUR;
                }
                // Recompute old breaks
                A.oldBreaks = [];
                for (let i = 0; i < A.oldSlots.length - 1; i++) {
                    const gap = A.oldSlots[i + 1].s - A.oldSlots[i].e;
                    A.oldBreaks.push(Math.max(0, gap));
                }
            }
            // Restore unit name
            if (userEdits.customUnitName !== null) customUnitName = userEdits.customUnitName;
            // Restore notes
            if (userEdits.schedNotes !== null) schedNotes = [...userEdits.schedNotes];
            // Restore time format
            if (userEdits.timeFormat !== null) timeFormat = userEdits.timeFormat;
        }
        let RS = []; // will be computed from ramadanStart + ramadanBreaks
        function computeRS() {
            RS = [];
            let t = ramadanStart;
            for (let i = 0; i < 10; i++) {
                RS.push({ s: m2hm(t), e: m2hm(t + LECTURE_DUR) });
                t += LECTURE_DUR;
                if (i < 9) t += ramadanBreaks[i];
            }
        }
        computeRS();
        const DAYS = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس'];
        function normDay(d) { let x = d.trim().replace(/\s+/g, ' '); x = x.replace(/الاربعاء/g, 'الأربعاء'); return x }

        // Unicode NFC normalization — ensures Arabic characters use
        // composed form so PDF text is searchable on all devices (especially mobile)
        function nfc(s) { return s ? s.normalize('NFC') : s }

        // Split a raw day field that may contain multiple day names
        // e.g. " الاثنين  الأربعاء   " → ['الاثنين', 'الأربعاء']
        function splitDays(rawDay) {
            let x = rawDay.trim().replace(/\s+/g, ' ');
            x = x.replace(/الاربعاء/g, 'الأربعاء');
            const found = [];
            for (const name of DAYS) {
                if (x.includes(name)) found.push(name);
            }
            return found.length > 0 ? found : [x];
        }

        function toast(m, t = 'ok') { const c = document.getElementById('TC'), d = document.createElement('div'); d.className = 'tst ' + t; d.textContent = m; c.appendChild(d); setTimeout(() => d.remove(), 3500) }

        function goTo(n) {
            if (n > 1 && A.recs.length === 0) { toast('يرجى رفع ملف CSV أولاً', 'er'); return }
            if (n === 2) {
                renderMismatchTable();
            }
            if (n === 3) {
                renderMismatchTable(); // ensure A.mismatchCount is up-to-date for warning
                // Warn user about mismatches before proceeding
                if (A.mismatchCount > 0) {
                    const proceed = confirm(
                        '⚠ تحذير: يوجد ' + A.mismatchCount + ' رقم مرجعي بأوقات غير متطابقة مع الفترات المحسوبة.\n\n'
                        + 'الأوقات غير المتطابقة ستُحوَّل تقريبياً وستظهر بلون أحمر في الجداول للتنبيه.\n\n'
                        + 'هل تريد الإكمال على مسؤوليتك؟\n\n'
                        + '• موافق = إكمال مع عرض الأوقات الغير دقيقة بالأحمر\n'
                        + '• إلغاء = العودة للإعدادات لمراجعة المشكلة'
                    );
                    if (!proceed) return;
                }
                readSlots(); renderTL();
                // Populate unit name input from CSV data (first trainee's unit)
                const uInput = document.getElementById('unitNameInput');
                if (uInput && !customUnitName) {
                    const firstTrainee = A.trainees.values().next().value;
                    if (firstTrainee && firstTrainee.un) {
                        customUnitName = firstTrainee.un;
                        uInput.value = customUnitName;
                    }
                } else if (uInput && customUnitName) {
                    uInput.value = customUnitName;
                }
                // Restore time format selector
                const tfSel = document.getElementById('timeFormatSel');
                if (tfSel) tfSel.value = timeFormat;
                // Auto-select first trainee if none selected
                if (!A.selId || !A.trainees.has(A.selId)) {
                    const sorted = getSorted();
                    if (sorted.length > 0) {
                        selT(sorted[0].tid);
                    }
                } else {
                    // Re-render preview for the currently selected trainee
                    renderPrev(A.selId);
                    document.getElementById('bPS').disabled = false;
                }
            }
            document.querySelectorAll('.scr').forEach(s => s.classList.remove('active'));
            document.getElementById('s' + n).classList.add('active');
            document.querySelectorAll('.si[data-s]').forEach(s => {
                const sn = +s.dataset.s; s.classList.remove('act', 'dn');
                if (sn === n) s.classList.add('act'); else if (sn < n) s.classList.add('dn');
            });
            document.querySelectorAll('.sc').forEach((c, i) => c.classList.toggle('done', i < n - 1));
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ══════════════════════════════════════════════════════════
        //  CSV
        // ══════════════════════════════════════════════════════════
        function handleFile(f) {
            if (!f || !f.name.toLowerCase().endsWith('.csv')) { toast('يرجى اختيار ملف CSV', 'er'); return }
            document.getElementById('UZ').innerHTML = '<span class="spinner"></span><div class="uzt" style="margin-top:16px">جاري تحليل الملف...</div>';
            Papa.parse(f, {
                header: true, encoding: 'UTF-8', skipEmptyLines: true,
                transformHeader: h => h.trim().replace(/^\uFEFF/, ''),
                complete: r => processCSV(r.data),
                error: e => { toast('خطأ: ' + e.message, 'er') }
            });
        }

        function processCSV(data) {
            // Save any existing manual edits before resetting
            if (A.recs.length > 0) saveUserEdits();
            A.recs = []; A.trainees = new Map(); A.gMin = Infinity; A.maxSlot = 0; A.mismatchCount = 0; A.mismatchRefs = new Set();
            // Only reset customUnitName if no user edit stored
            if (!userEdits.hasEdits || userEdits.customUnitName === null) customUnitName = '';
            for (const row of data) {
                const tid = nfc((row['الرقم التدريبي'] || '').trim());
                const nm = nfc((row['اسم المتدرب'] || '').trim());
                const rawDay = row['اليوم'] || '';
                const tm = (row['الوقت'] || '').trim();
                const cr = nfc((row['المقرر'] || '').trim());
                const ct = nfc((row['عنوان المقرر'] || '').trim());
                const rf = nfc((row['ر.مرجعي'] || '').trim());
                const tp = nfc((row['محاضرة/عملي'] || '').trim());
                const rn = nfc((row['الغرفة'] || '').trim());
                const courseStatus = nfc((row['حالة المقرر'] || '').trim());
                const ad = nfc((row['اسم المرشد'] || '').trim());
                const dp = nfc((row['القسم'] || '').trim());
                const pg = nfc((row['البرنامج'] || '').trim());
                const sm = nfc((row['الفصل التدريبي'] || '').trim());
                const un = nfc((row['الوحدة التدريبية'] || '').trim());
                if (!tid || !tm) continue;
                const pt = parseTime(tm); if (!pt) continue;
                if (pt.s < A.gMin) A.gMin = pt.s;

                // Split multi-day cells: e.g. "الاثنين  الأربعاء" → two separate records
                const days = splitDays(rawDay);
                for (const dy of days) {
                    const rec = { tid, nm, dy, tm, cr, ct, rf, tp, rn, ad, dp, pg, sm, un, pt, courseStatus };
                    A.recs.push(rec);
                    if (!A.trainees.has(tid)) A.trainees.set(tid, { tid, nm, dp, pg, ad, un, sm, recs: [] });
                    A.trainees.get(tid).recs.push(rec);
                }
            }
            // Filter out trainees whose ALL courses have withdrawn/dismissed statuses
            const excludeStatuses = ['انسحاب فصلي', 'مطوي قيده', 'مطوي قيده لإنقطاع أسبوعين'];
            const toRemove = [];
            for (const [tid, trainee] of A.trainees) {
                const allExcluded = trainee.recs.every(r => excludeStatuses.includes(r.courseStatus));
                if (allExcluded && trainee.recs.length > 0) {
                    toRemove.push(tid);
                }
            }
            for (const tid of toRemove) {
                A.trainees.delete(tid);
                A.recs = A.recs.filter(r => r.tid !== tid);
            }

            for (const r of A.recs) {
                const off = r.pt.s - A.gMin, si = Math.round(off / 50), np = Math.round(r.pt.d / 50), ei = si + np;
                if (ei > A.maxSlot) A.maxSlot = ei;
            }
            document.getElementById('sT').textContent = A.trainees.size;
            document.getElementById('sR').textContent = A.recs.length;
            document.getElementById('sM').textContent = m2hm(A.gMin);
            document.getElementById('sX').textContent = A.maxSlot;
            // Compute old slots from the CSV data
            computeOldSlots();

            document.getElementById('US').style.display = 'block';
            document.getElementById('b2').disabled = false;
            const uz = document.getElementById('UZ');
            uz.innerHTML = '<span class="uzi"><i data-lucide="check-circle" style="width:3rem;height:3rem;stroke:var(--ok)"></i></span><div class="uzt">تم تحليل الملف بنجاح</div><div class="uzh">' + A.trainees.size + ' متدرب — ' + A.recs.length + ' محاضرة</div>';
            uz.onclick = () => document.getElementById('FI').click();
            toast('تم استيراد ' + A.trainees.size + ' متدرب و ' + A.recs.length + ' محاضرة');
            // Restore user manual edits (Ramadan times, old times, unit name, note)
            restoreUserEdits();
            renderSlotsUI();

            // Restore unit name input and note input on page 3
            const uInput = document.getElementById('unitNameInput');
            if (uInput && customUnitName) uInput.value = customUnitName;
            renderNoteInputs();
            const tfSel = document.getElementById('timeFormatSel');
            if (tfSel) tfSel.value = timeFormat;

            // If we're on page 3 (s3 is active), refresh the trainee list and preview
            const s3 = document.getElementById('s3');
            if (s3 && s3.classList.contains('active')) {
                readSlots();
                renderTL(document.getElementById('SI') ? document.getElementById('SI').value.trim() : '');
                // Auto-select first trainee from the new file
                const sorted = getSorted();
                if (sorted.length > 0) {
                    selT(sorted[0].tid);
                } else {
                    A.selId = null;
                    document.getElementById('PF').innerHTML = '<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:200px;color:var(--mut)"><span style="opacity:.3;margin-bottom:12px"><i data-lucide="clipboard-list" style="width:3rem;height:3rem;stroke:var(--mut)"></i></span>اختر متدرباً لمعاينة جدوله</div>';
                    document.getElementById('bPS').disabled = true;
                }
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Compute old (pre-Ramadan) time slots from actual CSV data
        // Algorithm: collect unique start times → sort → fill gaps ≥ 50 min with inferred lectures → build 50-min slots
        // Also tracks: which slots come from CSV vs inferred, and nearby actual times with ref numbers
        const OLD_DUR = 50; // Old lecture duration in minutes
        function computeOldSlots() {
            if (A.recs.length === 0) return;

            // Step 1: Collect all unique start times (rounded to nearest 5 min for minor variations)
            const startSet = new Set();
            // Also collect raw (unrounded) starts with their ref numbers
            const rawStartMap = new Map(); // rounded → [{actualMin, ref, cr, ct}]
            for (const r of A.recs) {
                const s = r.pt.s;
                const rounded = Math.round(s / 5) * 5;
                startSet.add(rounded);
                if (!rawStartMap.has(rounded)) rawStartMap.set(rounded, []);
                // Avoid duplicate refs per rounded start
                const arr = rawStartMap.get(rounded);
                if (!arr.some(x => x.ref === r.rf && x.actualMin === s)) {
                    arr.push({ actualMin: s, ref: r.rf || '', cr: r.cr || '', ct: r.ct || '' });
                }
            }

            // Step 2: Sort unique starts ascending
            const csvStarts = new Set(startSet); // remember which came from CSV
            const uniqueStarts = [...startSet].sort((a, b) => a - b);
            if (uniqueStarts.length === 0) return;

            // Step 3: Build complete start list, filling gaps ≥ 50 min with inferred lectures
            const allStarts = [];
            const allFromCSV = []; // parallel array: true if from CSV, false if inferred
            for (let i = 0; i < uniqueStarts.length; i++) {
                allStarts.push(uniqueStarts[i]);
                allFromCSV.push(true);
                if (i < uniqueStarts.length - 1) {
                    let currentEnd = uniqueStarts[i] + OLD_DUR;
                    const nextStart = uniqueStarts[i + 1];
                    while (nextStart - currentEnd >= OLD_DUR) {
                        allStarts.push(currentEnd);
                        allFromCSV.push(false); // inferred
                        currentEnd += OLD_DUR;
                    }
                }
            }

            // Step 4: Build old slots with metadata
            A.oldSlots = [];
            for (let i = 0; i < allStarts.length; i++) {
                const s = allStarts[i];
                const fromCSV = allFromCSV[i];
                // Collect nearby actual times for this slot
                const nearby = [];
                if (fromCSV && rawStartMap.has(s)) {
                    for (const entry of rawStartMap.get(s)) {
                        if (entry.actualMin !== s) { // only non-exact matches
                            nearby.push(entry);
                        }
                    }
                }
                A.oldSlots.push({
                    s: s, e: s + OLD_DUR,
                    fromCSV: fromCSV,
                    nearbyTimes: nearby
                });
            }

            // Fill remaining if fewer slots than RS.length
            while (A.oldSlots.length < RS.length) {
                const prev = A.oldSlots[A.oldSlots.length - 1];
                A.oldSlots.push({ s: prev.e, e: prev.e + OLD_DUR, fromCSV: false, nearbyTimes: [] });
            }

            // Step 5: Compute old breaks
            A.oldBreaks = [];
            for (let i = 0; i < A.oldSlots.length - 1; i++) {
                const gap = A.oldSlots[i + 1].s - A.oldSlots[i].e;
                A.oldBreaks.push(Math.max(0, gap));
            }
        }

        function parseTime(s) { const m = s.match(/(\d{4})\s*-\s*(\d{4})/); if (!m) return null; const es = m[1], ss = m[2]; return { s: +ss.substring(0, 2) * 60 + +ss.substring(2, 4), e: +es.substring(0, 2) * 60 + +es.substring(2, 4), d: (+es.substring(0, 2) * 60 + +es.substring(2, 4)) - (+ss.substring(0, 2) * 60 + +ss.substring(2, 4)) } }
        function m2hm(m) { return String(Math.floor(m / 60)).padStart(2, '0') + ':' + String(m % 60).padStart(2, '0') }
        function t12(s) {
            if (!s || s === '--:--') return s;
            const p = s.split(':');
            let h = parseInt(p[0]);
            let m = p[1];
            let ampm = h >= 12 ? 'م' : 'ص';
            h = h % 12;
            if (h === 0) h = 12;
            const timeStr = String(h).padStart(2, '0') + ':' + m;
            // High-precision fix: Using inline-flex with forced LTR direction to ensure
            // the indicator (ص/م) is visually to the left of the numbers, matching the input.
            return `<span style="display:inline-flex;direction:ltr;gap:4px;align-items:baseline;unicode-bidi:isolate"><span>${ampm}</span><span>${timeStr}</span></span>`;
        }

        // Plain-text 12h format for schedule display (no HTML spans)
        function t12Plain(s) {
            if (!s || s === '--:--') return s;
            const p = s.split(':');
            let h = parseInt(p[0]);
            let m = p[1];
            let ampm = h >= 12 ? 'م' : 'ص';
            h = h % 12;
            if (h === 0) h = 12;
            return String(h).padStart(2, '0') + ':' + m + ' ' + ampm;
        }

        // Format time for schedule display based on current timeFormat setting
        function schedTime(hm24) {
            if (!hm24 || hm24 === '--:--') return hm24;
            return timeFormat === '12h' ? t12Plain(hm24) : hm24;
        }
        // Convert old (original/pre-Ramadan) schedule to Ramadan:
        // 1. Find lecture index by matching start time against A.oldSlots (accounts for breaks)
        // 2. Determine number of lectures (fractional): np = duration / 50  (e.g. 1.5)
        // 3. Start = Ramadan start of lecture si
        // 4. End = start + round(np × 35) — breaks are OUTSIDE the lecture duration
        // 5. Flag mismatched records (ref in A.mismatchRefs) with .mismatch = true
        function conv(rec) {
            // Match against A.oldSlots for accurate index (avoids break-drift from off/50)
            let si = 0;
            if (A.oldSlots && A.oldSlots.length > 0) {
                let bestDist = Infinity;
                for (let i = 0; i < A.oldSlots.length; i++) {
                    const dist = Math.abs(rec.pt.s - A.oldSlots[i].s);
                    if (dist < bestDist) { bestDist = dist; si = i; }
                }
            } else {
                const off = rec.pt.s - A.gMin;
                si = Math.min(Math.round(off / 50), RS.length - 1);
            }
            si = Math.min(si, RS.length - 1);
            const np = Math.max(0.5, rec.pt.d / 50); // fractional: e.g. 75min/50 = 1.5
            const startMin = timeToMin(RS[si].s);
            const endMin = startMin + Math.round(np * LECTURE_DUR); // round final minutes
            const isMismatch = A.mismatchRefs && A.mismatchRefs.has(rec.rf);
            return { si, np, rs: RS[si].s, re: m2hm(endMin), mismatch: isMismatch };
        }
        function simplifyType(t) { if (t.includes('نظري')) return 'نظري'; if (t.includes('عملي')) return 'عملي'; if (t.includes('تعاوني')) return 'تعاوني'; return t }
        function buildSch(t) { const bd = {}; for (const r of t.recs) { const d = normDay(r.dy); if (!bd[d]) bd[d] = []; bd[d].push(r) } for (const d of Object.keys(bd)) bd[d].sort((a, b) => a.pt.s - b.pt.s); return bd }

        // ══════════════════════════════════════════════════════════
        //  SETTINGS
        // ══════════════════════════════════════════════════════════
        function timeToMin(t) { if (!t) return 0; const p = t.split(':'); return (+p[0]) * 60 + (+p[1]) }

        function renderSlotsUI() {
            computeRS();
            const g = document.getElementById('SG'); g.innerHTML = '';
            const numSlots = Math.max(RS.length, A.oldSlots ? A.oldSlots.length : 0);

            // Helper: dual time display (24h primary + 12h small)
            function dualTime(hm24) {
                if (!hm24 || hm24 === '--:--') return '--:--';
                return hm24 + ' <span class="t12-hint">' + t12(hm24) + '</span>';
            }

            // Two-column layout
            const cols = document.createElement('div'); cols.className = 'sg-columns';

            // === RAMADAN COLUMN ===
            const colR = document.createElement('div'); colR.className = 'sg-col sg-col-ramadan';
            colR.innerHTML = '<div class="sg-col-title"><i data-lucide="moon" style="width:14px;height:14px;vertical-align:middle;margin-left:4px"></i> أوقات رمضان (35 د)</div>';

            for (let i = 0; i < RS.length; i++) {
                const row = document.createElement('div'); row.className = 'sr-row';
                row.innerHTML = '<span class="srl">محاضرة ' + (i + 1) + '</span>'
                    + '<div class="arrow-btn"><button onclick="adjustStart(' + i + ', 5)" title="تأخير 5 د">▲</button><button onclick="adjustStart(' + i + ', -5)" title="تقديم 5 د">▼</button></div>'
                    + '<span class="time-wrap"><input type="text" class="start-input" id="rs' + i + '" value="' + RS[i].s + '" pattern="[0-2][0-9]:[0-5][0-9]" placeholder="HH:MM" maxlength="5" onchange="onStartChange(' + i + ')" dir="ltr"><span class="t12-hint" id="rsh' + i + '">' + t12(RS[i].s) + '</span></span>'
                    + '<span class="time-sep">-</span>'
                    + '<span class="time-wrap"><span class="time-val end-val" id="re' + i + '">' + RS[i].e + '</span><span class="t12-hint" id="reh' + i + '">' + t12(RS[i].e) + '</span></span>';
                colR.appendChild(row);
                if (i < RS.length - 1) {
                    const brk = document.createElement('div');
                    brk.className = 'brk-row';
                    brk.id = 'rbrk' + i;
                    colR.appendChild(brk);
                }
            }

            // === DIVIDER ===
            const divider = document.createElement('div'); divider.className = 'sg-col-divider';

            // === OLD COLUMN (EDITABLE) ===
            const colO = document.createElement('div'); colO.className = 'sg-col sg-col-old';
            colO.innerHTML = '<div class="sg-col-title"><i data-lucide="calendar" style="width:14px;height:14px;vertical-align:middle;margin-left:4px"></i> الأوقات الأصلية «قبل رمضان» (50 د)</div>';

            const oldLen = A.oldSlots ? A.oldSlots.length : 0;
            for (let i = 0; i < numSlots; i++) {
                const slot = (i < oldLen) ? A.oldSlots[i] : null;
                const oldS = slot ? m2hm(slot.s) : '--:--';
                const oldE = slot ? m2hm(slot.e) : '--:--';
                const isCSV = slot && slot.fromCSV;

                // Build tooltip text
                let tipLines = [];
                if (isCSV) {
                    tipLines.push('📄 بداية من الملف (قطعية)');
                    if (slot.nearbyTimes && slot.nearbyTimes.length > 0) {
                        tipLines.push('⚠ بدايات قريبة فعلية:');
                        for (const nt of slot.nearbyTimes) {
                            tipLines.push('  · ' + m2hm(nt.actualMin) + ' — ر.م: ' + nt.ref + ' (' + nt.cr + ')');
                        }
                    }
                } else if (slot) {
                    tipLines.push('🔧 بداية محسوبة (مُستنتجة من فجوة بين فترتين)');
                }
                const tipText = tipLines.join('\n');

                // Color indicator
                const dotColor = isCSV ? '#4caf50' : '#ff9800';
                const dotTitle = isCSV ? 'من الملف' : 'محسوبة';

                const row = document.createElement('div'); row.className = 'sr-row';
                row.innerHTML = '<span class="srl">'
                    + '<span class="slot-dot" style="background:' + dotColor + '" title="' + dotTitle + '"></span>'
                    + 'محاضرة ' + (i + 1) + '</span>'
                    + '<div class="arrow-btn"><button onclick="adjustOldStart(' + i + ', 5)" title="تأخير 5 د">▲</button><button onclick="adjustOldStart(' + i + ', -5)" title="تقديم 5 د">▼</button></div>'
                    + '<span class="time-wrap"><input type="text" class="start-input" id="os' + i + '" value="' + oldS + '" pattern="[0-2][0-9]:[0-5][0-9]" placeholder="HH:MM" maxlength="5" onchange="onOldStartChange(' + i + ')" dir="ltr"><span class="t12-hint" id="osh' + i + '">' + t12(oldS) + '</span></span>'
                    + '<span class="time-sep">-</span>'
                    + '<span class="time-wrap"><span class="time-val end-val" id="oe' + i + '">' + oldE + '</span><span class="t12-hint" id="oeh' + i + '">' + t12(oldE) + '</span></span>';

                // Attach tooltip balloon on hover
                if (tipText) {
                    row.classList.add('has-slot-tip');
                    row.setAttribute('data-slot-tip', tipText);
                }

                colO.appendChild(row);
                if (i < numSlots - 1) {
                    const brk = document.createElement('div');
                    brk.className = 'brk-row';
                    brk.id = 'obrk' + i;
                    colO.appendChild(brk);
                }
            }

            cols.appendChild(colR);
            cols.appendChild(divider);
            cols.appendChild(colO);
            g.appendChild(cols);

            updateAllBreakLabels();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function adjustStart(idx, delta) {
            const el = document.getElementById('rs' + idx);
            if (!el) return;
            let startMin = timeToMin(el.value) + delta;
            if (startMin < 0) startMin = 0;
            if (startMin > 23 * 60 + 55) startMin = 23 * 60 + 55;

            // PREVENT: cannot start before previous lecture ends
            if (idx > 0) {
                const prevEnd = timeToMin(RS[idx - 1].e);
                if (startMin < prevEnd) {
                    startMin = prevEnd;
                    toast('لا يمكن التقديم أكثر — المحاضرة السابقة لم تنتهِ بعد', 'er');
                }
            }

            el.value = m2hm(startMin);
            onStartChange(idx);
        }

        function onStartChange(idx) {
            userEdits.hasEdits = true; // Mark as manually edited
            const el = document.getElementById('rs' + idx);
            if (!el) return;
            let newStart = timeToMin(el.value);

            // VALIDATION: cannot start before previous lecture ends
            if (idx > 0) {
                const prevEnd = timeToMin(RS[idx - 1].e);
                if (newStart < prevEnd) {
                    newStart = prevEnd;
                    el.value = m2hm(newStart);
                    toast('تم تصحيح البداية — لا يمكن أن تسبق نهاية المحاضرة ' + idx, 'er');
                }
            }

            // Update RS[idx]
            RS[idx].s = m2hm(newStart);
            RS[idx].e = m2hm(newStart + LECTURE_DUR);

            // Compute the break before idx
            if (idx > 0) {
                const prevEnd = timeToMin(RS[idx - 1].e);
                ramadanBreaks[idx - 1] = Math.max(0, newStart - prevEnd);
            } else {
                ramadanStart = newStart;
            }

            // Cascade forward: update all slots after idx
            let t = newStart + LECTURE_DUR;
            for (let i = idx + 1; i < 10; i++) {
                t += ramadanBreaks[i - 1];
                RS[i].s = m2hm(t);
                RS[i].e = m2hm(t + LECTURE_DUR);
                t += LECTURE_DUR;
            }

            // Update all UI
            for (let i = 0; i < RS.length; i++) {
                const sEl = document.getElementById('rs' + i);
                const eEl = document.getElementById('re' + i);
                const shEl = document.getElementById('rsh' + i);
                const ehEl = document.getElementById('reh' + i);
                if (sEl) sEl.value = RS[i].s;
                if (shEl) shEl.innerHTML = t12(RS[i].s);
                if (eEl) eEl.textContent = RS[i].e;
                if (ehEl) ehEl.innerHTML = t12(RS[i].e);
            }

            updateAllBreakLabels();
        }

        function updateAllBreakLabels() {
            // Ramadan breaks
            for (let i = 0; i < RS.length - 1; i++) {
                const brkEl = document.getElementById('rbrk' + i);
                if (!brkEl) continue;
                const endMin = timeToMin(RS[i].e);
                const nextStart = timeToMin(RS[i + 1].s);
                const gap = nextStart - endMin;
                ramadanBreaks[i] = Math.max(0, gap);
                brkEl.className = 'brk-row';
                if (gap <= 0) {
                    brkEl.textContent = '—';
                    brkEl.classList.add('brk-none');
                } else {
                    brkEl.textContent = 'فاصل ' + gap + ' د';
                    brkEl.classList.add('brk-rest');
                }
            }
            // Old breaks — compute from A.oldSlots directly
            const oldLen = A.oldSlots ? A.oldSlots.length : 0;
            for (let i = 0; i < oldLen - 1; i++) {
                const brkEl = document.getElementById('obrk' + i);
                if (!brkEl) continue;
                const gap = A.oldSlots[i + 1].s - A.oldSlots[i].e;
                A.oldBreaks[i] = Math.max(0, gap);
                brkEl.className = 'brk-row';
                if (gap <= 0) {
                    brkEl.textContent = '—';
                    brkEl.classList.add('brk-none');
                } else {
                    brkEl.textContent = 'فاصل ' + gap + ' د';
                }
            }
        }

        // === OLD SLOT EDITING (mirror of Ramadan slot editing) ===
        function adjustOldStart(idx, delta) {
            if (!A.oldSlots || !A.oldSlots[idx]) return;
            let startMin = A.oldSlots[idx].s + delta;
            if (startMin < 0) startMin = 0;
            if (startMin > 23 * 60 + 55) startMin = 23 * 60 + 55;
            // Cannot start before previous lecture ends
            if (idx > 0) {
                const prevEnd = A.oldSlots[idx - 1].e;
                if (startMin < prevEnd) {
                    startMin = prevEnd;
                    toast('لا يمكن التقديم أكثر — المحاضرة السابقة لم تنتهِ بعد', 'er');
                }
            }
            A.oldSlots[idx].s = startMin;
            A.oldSlots[idx].e = startMin + OLD_DUR;
            cascadeOldSlots(idx);
            refreshOldUI();
        }

        function onOldStartChange(idx) {
            userEdits.hasEdits = true; // Mark as manually edited
            if (!A.oldSlots || !A.oldSlots[idx]) return;
            const el = document.getElementById('os' + idx);
            if (!el) return;
            let newStart = timeToMin(el.value);
            // Validation: cannot start before previous lecture ends
            if (idx > 0) {
                const prevEnd = A.oldSlots[idx - 1].e;
                if (newStart < prevEnd) {
                    newStart = prevEnd;
                    el.value = m2hm(newStart);
                    toast('تم تصحيح البداية — لا يمكن أن تسبق نهاية المحاضرة ' + idx, 'er');
                }
            }
            A.oldSlots[idx].s = newStart;
            A.oldSlots[idx].e = newStart + OLD_DUR;
            cascadeOldSlots(idx);
            refreshOldUI();
        }

        // Cascade: recompute all slots after idx maintaining their breaks
        function cascadeOldSlots(fromIdx) {
            for (let i = fromIdx + 1; i < A.oldSlots.length; i++) {
                const brk = (A.oldBreaks && A.oldBreaks[i - 1] !== undefined) ? A.oldBreaks[i - 1] : 0;
                const minStart = A.oldSlots[i - 1].e; // cannot start before previous ends
                const currentStart = A.oldSlots[i].s;
                // Only push forward if current start would overlap
                if (currentStart < minStart) {
                    A.oldSlots[i].s = minStart + brk;
                    A.oldSlots[i].e = A.oldSlots[i].s + OLD_DUR;
                } else {
                    // Recompute end to ensure 50 min duration
                    A.oldSlots[i].e = A.oldSlots[i].s + OLD_DUR;
                }
            }
            // Recompute breaks
            A.oldBreaks = [];
            for (let i = 0; i < A.oldSlots.length - 1; i++) {
                A.oldBreaks.push(Math.max(0, A.oldSlots[i + 1].s - A.oldSlots[i].e));
            }
        }

        function refreshOldUI() {
            for (let i = 0; i < A.oldSlots.length; i++) {
                const sEl = document.getElementById('os' + i);
                const eEl = document.getElementById('oe' + i);
                const shEl = document.getElementById('osh' + i);
                const ehEl = document.getElementById('oeh' + i);
                if (sEl) sEl.value = m2hm(A.oldSlots[i].s);
                if (shEl) shEl.innerHTML = t12(m2hm(A.oldSlots[i].s));
                if (eEl) eEl.textContent = m2hm(A.oldSlots[i].e);
                if (ehEl) ehEl.innerHTML = t12(m2hm(A.oldSlots[i].e));
            }
            updateAllBreakLabels();
        }

        function readSlots() { computeRS(); }

        // Render mismatched times table on page 2
        // Columns: # | رمز المقرر | اسم المقرر | ر مرجعي | اليوم | الوقت | السبب | مثال لمتدرب
        // Deduplicated by ر.مرجعي (ref number)
        function renderMismatchTable() {
            const card = document.getElementById('mismatchCard');
            const container = document.getElementById('mismatchTable');
            A.mismatchCount = 0;
            if (!card || !container || !A.oldSlots || A.oldSlots.length === 0 || A.recs.length === 0) {
                if (card) card.style.display = 'none';
                return;
            }

            const TOLERANCE_START = 10; // max distance (min) to consider a "match"
            const TOLERANCE_DUR = 5;    // max deviation from multiple of 50

            const byRef = new Map(); // dedup by ref number

            for (const r of A.recs) {
                const ref = r.rf || '';
                if (!ref || byRef.has(ref)) continue;

                const startMin = r.pt.s;
                const dur = r.pt.d;

                // Check 1: Does start match any oldSlot?
                let closestSlot = 0, closestDist = Infinity;
                for (let i = 0; i < A.oldSlots.length; i++) {
                    const dist = Math.abs(startMin - A.oldSlots[i].s);
                    if (dist < closestDist) { closestDist = dist; closestSlot = i; }
                }
                const startMismatch = closestDist > TOLERANCE_START;

                // Check 2: Is duration a multiple of 50 (within tolerance)?
                const remainder = dur % 50;
                const durMismatch = remainder > TOLERANCE_DUR && remainder < (50 - TOLERANCE_DUR);

                if (startMismatch || durMismatch) {
                    // Find a trainee example for display
                    let tName = '';
                    for (const [tid, t] of A.trainees) {
                        if (t.recs.some(tr => tr === r)) {
                            tName = t.nm; break;
                        }
                    }

                    const closestTime = m2hm(A.oldSlots[closestSlot].s) + ' - ' + m2hm(A.oldSlots[closestSlot].e);
                    const actualTime = m2hm(r.pt.s) + ' - ' + m2hm(r.pt.e);

                    const reasons = [];
                    if (startMismatch) reasons.push('بداية غير متطابقة (الأقرب: ' + closestTime + ' — فرق ' + closestDist + ' د)');
                    if (durMismatch) reasons.push('مدة غير قياسية (' + dur + ' د ≠ مضاعف 50)');

                    byRef.set(ref, {
                        cr: r.cr || '', ct: r.ct || '', rf: ref,
                        dy: r.dy || '',
                        tm: actualTime,
                        reason: reasons.join(' ، '),
                        example: tName
                    });
                }
            }

            A.mismatchCount = byRef.size;
            A.mismatchRefs = new Set(byRef.keys());

            if (byRef.size === 0) {
                card.style.display = '';
                const descP = document.getElementById('mismatchDesc');
                if (descP) descP.style.display = 'none';
                card.querySelector('.ct').style.color = 'var(--ok)';
                card.querySelector('.ct').innerHTML = '<i data-lucide="check-circle" class="lucide-icon" style="stroke:var(--ok)"></i> جميع الأوقات متطابقة مع الفترات المحسوبة ✓';
                container.innerHTML = '';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            card.style.display = '';
            // Restore warning state
            const descP = document.getElementById('mismatchDesc');
            if (descP) descP.style.display = '';
            const ctEl = card.querySelector('.ct');
            ctEl.style.color = 'var(--acc)';
            ctEl.innerHTML = '<i data-lucide="alert-triangle" class="lucide-icon" style="stroke:var(--acc)"></i> أوقات غير متطابقة مع الفترات المحسوبة (' + byRef.size + ')';
            if (typeof lucide !== 'undefined') lucide.createIcons();

            const thStyle = 'padding:6px 8px;border:1px solid #e0d6c8;text-align:center';
            const tdStyle = 'padding:5px 8px;border:1px solid #e8e0d5;text-align:center';

            let h = '<table style="width:100%;border-collapse:collapse;font-size:.82rem;direction:rtl">';
            h += '<thead><tr style="background:#FFF3E0">';
            h += '<th style="' + thStyle + '">#</th>';
            h += '<th style="' + thStyle + '">رمز المقرر</th>';
            h += '<th style="' + thStyle + '">اسم المقرر</th>';
            h += '<th style="' + thStyle + '">ر.مرجعي</th>';
            h += '<th style="' + thStyle + '">اليوم</th>';
            h += '<th style="' + thStyle + '">الوقت</th>';
            h += '<th style="' + thStyle + '">السبب</th>';
            h += '<th style="' + thStyle + '">مثال لمتدرب</th>';
            h += '</tr></thead><tbody>';

            let idx = 0;
            for (const [ref, m] of byRef) {
                idx++;
                h += '<tr>';
                h += '<td style="' + tdStyle + '">' + idx + '</td>';
                h += '<td style="' + tdStyle + '">' + m.cr + '</td>';
                h += '<td style="' + tdStyle + '">' + m.ct + '</td>';
                h += '<td style="' + tdStyle + ';font-family:monospace">' + m.rf + '</td>';
                h += '<td style="' + tdStyle + '">' + m.dy + '</td>';
                h += '<td style="' + tdStyle + ';direction:ltr;font-family:monospace">' + m.tm + '</td>';
                h += '<td style="' + tdStyle + ';font-size:.75rem;color:#c62828;text-align:right">' + m.reason + '</td>';
                h += '<td style="' + tdStyle + '">' + m.example + '</td>';
                h += '</tr>';
            }
            h += '</tbody></table>';
            container.innerHTML = h;
        }

        function resetS() {
            ramadanStart = DEFAULT_START;
            ramadanBreaks = [...DEFAULT_BREAKS];
            computeRS();
            renderSlotsUI();
            toast('تم إعادة الأوقات للقيم الافتراضية');
        }

        // ══════════════════════════════════════════════════════════
        //  LIST & PREVIEW
        // ══════════════════════════════════════════════════════════
        function getSorted() {
            const arr = [...A.trainees.values()];
            if (sortOrder === 'name') return arr.sort((a, b) => a.nm.localeCompare(b.nm, 'ar'));
            return arr.sort((a, b) => a.tid.localeCompare(b.tid, 'ar'));
        }
        function renderTL(q = '') {
            const l = document.getElementById('TL'); l.innerHTML = '';
            const sorted = getSorted();
            const fl = q ? sorted.filter(t => t.nm.includes(q) || t.tid.includes(q)) : sorted;
            for (const t of fl) {
                const d = document.createElement('div'); d.className = 'ti' + (A.selId === t.tid ? ' sel' : '');
                d.innerHTML = '<div style="flex:1"><div class="tn">' + t.nm + '</div><div class="tid2">' + t.tid + '</div></div><div class="tde">' + t.dp + '</div>';
                d.addEventListener('click', () => selT(t.tid)); l.appendChild(d);
            }
        }
        function filt() { renderTL(document.getElementById('SI').value.trim()) }
        function selT(id) { A.selId = id; renderTL(document.getElementById('SI').value.trim()); renderPrev(id); document.getElementById('bPS').disabled = false }

        function renderPrev(tid) {
            const f = document.getElementById('PF'), t = A.trainees.get(tid); if (!t) return; readSlots();
            f.innerHTML = buildPageHTML(t);
            // Mismatch warning
            if (A.mismatchCount > 0) {
                toast('⚠ يوجد ' + A.mismatchCount + ' رقم مرجعي بأوقات غير متطابقة — راجع صفحة الإعدادات', 'er');
            }
        }

        // Called when user edits the unit name
        function onUnitNameChange() {
            const input = document.getElementById('unitNameInput');
            if (input) customUnitName = input.value.trim();
            userEdits.hasEdits = true;
            userEdits.customUnitName = customUnitName;
            // Re-render preview if a trainee is selected
            if (A.selId) renderPrev(A.selId);
        }

        function onSortChange() {
            sortOrder = document.getElementById('sortOrder').value;
            renderTL(document.getElementById('SI').value.trim());
        }

        function onGenderChange() {
            genderType = document.getElementById('genderType').value;
            // Re-render preview if a trainee is selected
            if (A.selId) renderPrev(A.selId);
        }

        // ═══ MULTI-NOTE SYSTEM ═══
        function renderNoteInputs() {
            const container = document.getElementById('noteInputs');
            if (!container) return;
            let h = '';
            for (let i = 0; i < schedNotes.length; i++) {
                h += '<div class="note-entry">';
                if (schedNotes.length > 1) h += '<span class="note-num">' + (i + 1) + '</span>';
                h += '<textarea id="noteInput' + i + '" rows="2" placeholder="أضف ملاحظة تظهر في جميع الجداول..." oninput="onNoteChange()">' + (schedNotes[i] || '') + '</textarea>';
                if (schedNotes.length > 1) h += '<button class="note-remove-btn" onclick="removeNote(' + i + ')" title="حذف هذه الملاحظة">&times;</button>';
                h += '</div>';
            }
            container.innerHTML = h;
        }

        function addNote() {
            schedNotes.push('');
            renderNoteInputs();
            // Focus the new textarea
            const el = document.getElementById('noteInput' + (schedNotes.length - 1));
            if (el) el.focus();
        }

        function removeNote(idx) {
            if (schedNotes.length <= 1) return;
            schedNotes.splice(idx, 1);
            renderNoteInputs();
            onNoteChange();
        }

        function onNoteChange() {
            // Read all note textareas into the array
            for (let i = 0; i < schedNotes.length; i++) {
                const el = document.getElementById('noteInput' + i);
                if (el) schedNotes[i] = el.value;
            }
            userEdits.hasEdits = true;
            userEdits.schedNotes = [...schedNotes];
            if (A.selId) renderPrev(A.selId);
        }

        function onTimeFormatChange() {
            timeFormat = document.getElementById('timeFormatSel').value;
            userEdits.hasEdits = true;
            userEdits.timeFormat = timeFormat;
            if (A.selId) renderPrev(A.selId);
        }

        // ══════════════════════════════════════════════════════════
        //  BUILD SCHEDULE PAGE HTML (used for preview AND print)
        // ══════════════════════════════════════════════════════════
        // Generate all possible Unicode normalization variants of a string
        // to maximize PDF search compatibility across all devices and OS versions
        function getSearchableVariants(name) {
            if (!name) return '';
            const variants = new Set();
            // NFC: Composed form (standard)
            variants.add(name.normalize('NFC'));
            // NFKC: Compatibility composed (resolves ligatures)
            variants.add(name.normalize('NFKC'));
            // NFD: Decomposed form (base + diacritics separate)
            variants.add(name.normalize('NFD'));
            // NFKD: Compatibility decomposed
            variants.add(name.normalize('NFKD'));
            // Strip diacritics/tashkeel completely (bare letters)
            const stripped = name.normalize('NFD').replace(/[\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED]/g, '').normalize('NFC');
            variants.add(stripped);
            // Also add without extra spaces
            variants.add(name.replace(/\s+/g, ' ').trim());
            return [...variants].join(' ');
        }

        function buildPageHTML(t) {
            const sch = buildSch(t);
            let h = '<div class="sched-page">';

            // ═══ INVISIBLE SEARCHABLE TEXT LAYER ═══
            // This hidden layer contains the trainee name and ID in plain system fonts
            // (Arial/Tahoma) which are natively supported on all mobile devices.
            // Even though the text is invisible, PDF renderers preserve it as
            // searchable text in the document's text stream.
            // Multiple Unicode normalization forms ensure the name is found
            // regardless of how the mobile OS decomposes/composes Arabic characters.
            const searchName = getSearchableVariants(t.nm);
            const searchTid = nfc(t.tid);
            h += '<div class="sp-search-layer" aria-hidden="true">';
            h += searchName + ' ' + searchTid;
            h += '</div>';

            // Header row: 3 columns (right=logo, center=texts, left=empty)
            h += '<div class="sp-header-row">';
            h += '<div class="sp-header-logo"><img src="logo.png"></div>';
            h += '<div class="sp-header-text">';
            h += nfc('المملكة العربية السعودية') + '<br>';
            h += nfc('المؤسسة العامة للتدريب التقني والمهني') + '<br>';
            h += nfc(customUnitName || t.un);
            h += '</div>';
            h += '<div class="sp-header-empty"></div>';
            h += '</div>';

            // Title (gender-aware)
            const titleLabel = nfc(genderType === 'female' ? 'جدول المتدربة لشهر رمضان المبارك' : 'جدول المتدرب لشهر رمضان المبارك');
            h += '<div class="sp-title-wrap"><div class="sp-title">' + titleLabel + '</div></div>';

            // Semester below title
            if (t.sm) {
                h += '<div class="sp-semester-wrap"><span class="sp-semester">' + t.sm + '</span></div>';
            }

            // Student info - RTL order (right to left)
            h += '<table class="sp-info"><tr>';
            h += '<td class="lbl">الرقم التدريبي</td><td>' + t.tid + '</td>';
            h += '<td class="lbl">التخصص</td><td>' + t.pg + '</td>';
            h += '</tr><tr>';
            const nameLabel = nfc(genderType === 'female' ? 'اسم المتدربة' : 'اسم المتدرب');
            h += '<td class="lbl">' + nameLabel + '</td><td>' + t.nm + '</td>';
            h += '<td class="lbl">القسم</td><td>' + t.dp + '</td>';
            h += '</tr></table>';

            // Schedule table
            h += '<table class="sp-tbl"><thead><tr>';
            h += '<th>اليوم</th><th>الوقت</th><th>المقرر</th><th>اسم المقرر</th><th>ر.مرجعي</th><th>نوع</th><th>القاعة</th>';
            h += '</tr></thead><tbody>';

            let isFirstDay = true;
            for (const day of DAYS) {
                const dr = sch[day]; if (!dr || !dr.length) continue;
                for (let i = 0; i < dr.length; i++) {
                    const r = dr[i], rm = conv(r);
                    // Add day separator (bold colored line between days)
                    const sepClass = (!isFirstDay && i === 0) ? ' class="day-separator"' : '';
                    h += '<tr' + sepClass + '>';
                    h += '<td class="day-c">' + day + '</td>';
                    // Format time based on user preference (24h or 12h)
                    const displayStart = schedTime(rm.rs);
                    const displayEnd = schedTime(rm.re);
                    // Color mismatched times in red
                    if (rm.mismatch) {
                        h += '<td class="time-c" style="color:#d32f2f;font-weight:700" title="وقت غير متطابق — تقريبي">' + displayStart + ' - ' + displayEnd + '</td>';
                    } else {
                        h += '<td class="time-c">' + displayStart + ' - ' + displayEnd + '</td>';
                    }
                    h += '<td>' + r.cr + '</td>';
                    h += '<td>' + r.ct + '</td>';
                    h += '<td>' + r.rf + '</td>';
                    h += '<td>' + simplifyType(r.tp) + '</td>';
                    h += '<td>' + r.rn + '</td>';
                    h += '</tr>';
                }
                isFirstDay = false;
            }
            h += '</tbody></table>';

            // Footer (gender-aware)
            const trainerLabel = nfc(genderType === 'female' ? 'المرشدة التدريبية' : 'المرشد التدريبي');
            h += '<div class="sp-footer">' + trainerLabel + ': ' + t.ad + '</div>';
            // Note
            // Render each non-empty note as its own box
            for (const note of schedNotes) {
                const trimmed = (note || '').trim();
                if (trimmed) {
                    h += '<div class="sp-note">' + nfc(trimmed) + '</div>';
                }
            }
            h += '</div>';
            return h;
        }

        // ══════════════════════════════════════════════════════════
        //  PRINT
        // ══════════════════════════════════════════════════════════
        function printAll() {
            readSlots();
            // Mismatch warning before printing
            if (A.mismatchCount > 0) {
                toast('⚠ يوجد ' + A.mismatchCount + ' رقم مرجعي بأوقات غير متطابقة — راجع صفحة الإعدادات', 'er');
            }
            const btn = document.getElementById('bPA');
            btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> جاري التجهيز...';
            const pw = document.getElementById('PW'); pw.classList.add('sh');

            setTimeout(() => {
                const area = document.getElementById('printArea');
                const sorted = getSorted();
                let html = '';
                for (let i = 0; i < sorted.length; i++) {
                    html += buildPageHTML(sorted[i]);
                    if (i % 20 === 0) {
                        document.getElementById('PFL').style.width = Math.round((i + 1) / sorted.length * 100) + '%';
                        document.getElementById('PTX').textContent = (i + 1) + ' / ' + sorted.length;
                    }
                }
                area.innerHTML = html;
                document.getElementById('PFL').style.width = '100%';
                document.getElementById('PTX').textContent = 'جاهز للطباعة!';

                setTimeout(() => {
                    window.print();
                    btn.disabled = false;
                    btn.innerHTML = '<i data-lucide="printer" style="width:16px;height:16px"></i> طباعة جميع الجداول'; if (typeof lucide !== 'undefined') lucide.createIcons();
                    setTimeout(() => pw.classList.remove('sh'), 1000);
                }, 300);
            }, 100);
        }

        function printOne() {
            if (!A.selId) return; readSlots();
            const t = A.trainees.get(A.selId); if (!t) return;
            const area = document.getElementById('printArea');
            area.innerHTML = buildPageHTML(t);
            setTimeout(() => window.print(), 200);
        }

        // ══════════════════════════════════════════════════════════
        //  EXPORT EXCEL (CSV)
        // ══════════════════════════════════════════════════════════
        function exportExcel() {
            if (A.recs.length === 0) { toast('لا توجد بيانات للتصدير', 'er'); return; }
            readSlots();

            const nameLabel = genderType === 'female' ? 'اسم المتدربة' : 'اسم المتدرب';
            const trainerLabel = genderType === 'female' ? 'المرشدة التدريبية' : 'المرشد التدريبي';

            // Helper: format old time from r.tm ("0910 - 0730") to readable format ("09:10 - 07:30")
            function formatOldTime(tm) {
                if (!tm) return '';
                // tm comes as "HHMM - HHMM" (end - start) from SS05
                // Keep the original format as-is (e.g. "0910 - 0730")
                return tm;
            }

            // Helper: find old lecture index by matching actual start time against A.oldSlots
            // Uses closest-match approach against the clustered old slots (which correctly account for breaks)
            function findOldSlotIndex(startMin) {
                if (!A.oldSlots || A.oldSlots.length === 0) return 0;
                let bestIdx = 0, bestDist = Infinity;
                for (let i = 0; i < A.oldSlots.length; i++) {
                    const dist = Math.abs(startMin - A.oldSlots[i].s);
                    if (dist < bestDist) { bestDist = dist; bestIdx = i; }
                }
                return bestIdx;
            }

            // Helper: compute old lecture numbers string
            // Uses A.oldSlots matching for accuracy (the naive off/50 formula drifts due to breaks)
            // Uses ~ separator instead of - to prevent Excel from interpreting "5~6" as a date
            function getOldLectureNumbers(rec) {
                const si = findOldSlotIndex(rec.pt.s);
                const np = Math.max(1, Math.ceil(rec.pt.d / 50)); // ceil for lecture numbering display
                const first = si + 1; // Convert to 1-based
                if (np <= 1) return String(first);
                const last = si + np;
                return first + '~' + last;
            }

            // CSV headers
            const headers = [
                nameLabel,
                'الرقم التدريبي',
                'القسم',
                'التخصص',
                'اليوم',
                'الوقت (قبل رمضان)',
                'رقم المحاضرة',
                'وقت البداية (رمضان)',
                'وقت النهاية (رمضان)',
                'المقرر',
                'عنوان المقرر',
                'ر.مرجعي',
                'النوع',
                'القاعة',
                trainerLabel
            ];

            // Build rows sorted by user preference, grouped by trainee then by day
            const sorted = getSorted();
            const rows = [];

            for (const t of sorted) {
                const sch = buildSch(t);
                for (const day of DAYS) {
                    const dr = sch[day];
                    if (!dr || !dr.length) continue;
                    for (const r of dr) {
                        const rm = conv(r);
                        const oldTime = formatOldTime(r.tm);
                        const lectureNums = getOldLectureNumbers(r);
                        rows.push([
                            nfc(t.nm),
                            nfc(t.tid),
                            nfc(t.dp),
                            nfc(t.pg),
                            nfc(day),
                            nfc(oldTime),
                            nfc(lectureNums),
                            nfc(rm.rs),
                            nfc(rm.re),
                            nfc(r.cr),
                            nfc(r.ct),
                            nfc(r.rf),
                            nfc(simplifyType(r.tp)),
                            nfc(r.rn),
                            nfc(t.ad)
                        ]);
                    }
                }
            }

            // Build CSV string
            function csvEscape(val) {
                const s = (val == null ? '' : String(val));
                if (s.includes(',') || s.includes('"') || s.includes('\n') || s.includes('\r')) {
                    return '"' + s.replace(/"/g, '""') + '"';
                }
                return s;
            }

            let csv = '\uFEFF'; // BOM for Excel Arabic support
            csv += headers.map(csvEscape).join(',') + '\r\n';
            for (const row of rows) {
                csv += row.map(csvEscape).join(',') + '\r\n';
            }

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'جداول_رمضان_' + new Date().toISOString().slice(0, 10) + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            toast('تم تصدير التقرير بنجاح (' + rows.length + ' سجل)');
        }

        // ══════════════════════════════════════════════════════════
        //  RAMADAN CARD (Canvas-based — fixes Arabic rendering)
        // ══════════════════════════════════════════════════════════
        let _rcBreakLabels = [];

        // Pre-load logo as data URL (via fetch+blob to avoid canvas taint on file://)
        let _logoImg = null;
        function loadLogoImage() {
            return new Promise(resolve => {
                if (_logoImg) { resolve(_logoImg); return; }
                // Try fetch approach first (works on http:// and some file://)
                fetch('logo.png').then(r => r.blob()).then(blob => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const img = new Image();
                        img.onload = () => { _logoImg = img; resolve(img); };
                        img.onerror = () => resolve(null);
                        img.src = reader.result;
                    };
                    reader.readAsDataURL(blob);
                }).catch(() => {
                    // Fallback: direct load (may taint canvas on file://)
                    const img = new Image();
                    img.onload = () => { _logoImg = img; resolve(img); };
                    img.onerror = () => resolve(null);
                    img.src = 'logo.png';
                });
            });
        }

        function openRamadanCard() {
            readSlots();
            const modal = document.getElementById('ramCardModal');
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            // Populate lecture count selector
            const sel = document.getElementById('rcLectureCount');
            sel.innerHTML = '';
            for (let n = 1; n <= RS.length; n++) {
                const opt = document.createElement('option');
                opt.value = n; opt.textContent = n;
                if (n === RS.length) opt.selected = true;
                sel.appendChild(opt);
            }

            // Pre-fill semester from CSV data if available
            const semInput = document.getElementById('rcSemester');
            if (semInput && !semInput.value) {
                const firstTrainee = A.trainees.size > 0 ? A.trainees.values().next().value : null;
                if (firstTrainee && firstTrainee.sm) semInput.value = firstTrainee.sm;
            }

            // Init break labels
            _rcBreakLabels = [];
            for (let i = 0; i < RS.length - 1; i++) {
                const brk = ramadanBreaks[i] || 0;
                _rcBreakLabels.push(brk > 0 ? 'فاصل ' + brk + ' د' : '');
            }
            buildBreakControls();

            if (typeof lucide !== 'undefined') lucide.createIcons();
            loadLogoImage().then(() => refreshRamadanPreview());
        }

        function closeRamadanCard() {
            document.getElementById('ramCardModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function buildBreakControls() {
            const wrap = document.getElementById('rcBreaksWrap');
            const count = parseInt(document.getElementById('rcLectureCount').value) || RS.length;
            let html = '<label style="font-size:.78rem;color:var(--mut)">أسماء الفواصل</label><div style="display:flex;flex-wrap:wrap;gap:6px">';
            for (let i = 0; i < count - 1; i++) {
                const brk = ramadanBreaks[i] || 0;
                if (brk <= 0) continue;
                html += '<input type="text" data-brk-idx="' + i + '" value="' + (_rcBreakLabels[i] || '') + '" onchange="onBrkLabelChange(this)" style="width:120px;padding:4px 8px;border:1px solid var(--bd);border-radius:5px;font-size:.78rem;text-align:center" dir="rtl">';
            }
            html += '</div>';
            wrap.innerHTML = html;
        }

        function onBrkLabelChange(el) {
            const idx = parseInt(el.getAttribute('data-brk-idx'));
            _rcBreakLabels[idx] = el.value;
            refreshRamadanPreview();
        }

        function refreshRamadanPreview() {
            buildBreakControls();
            const canvas = document.getElementById('rcCanvas');
            drawRamadanCard(canvas);
        }

        function drawRamadanCard(canvas) {
            const count = parseInt(document.getElementById('rcLectureCount').value) || RS.length;
            const notes = (document.getElementById('rcNotes') || {}).value || '';
            const semester = (document.getElementById('rcSemester') || {}).value || '';
            const unitName = customUnitName || (A.trainees.size > 0 ? A.trainees.values().next().value.un : '');

            // Collect breaks for visible lectures
            const visibleBreaks = [];
            for (let i = 0; i < count - 1; i++) {
                const brk = ramadanBreaks[i] || 0;
                if (brk > 0) visibleBreaks.push({ idx: i, brk, label: _rcBreakLabels[i] || 'فاصل ' + brk + ' د' });
            }

            // Dimensions
            const W = 700, SCALE = 2;
            const rowH = 44, brkH = 26, headerH = 36;
            const tableH = headerH + count * rowH + visibleBreaks.length * brkH;
            const semH = semester ? 28 : 0;
            const topSection = 180 + semH;
            const notesH = notes ? 40 : 0;
            const greetH = 70;
            const H = topSection + tableH + notesH + greetH + 40;

            canvas.width = W * SCALE;
            canvas.height = H * SCALE;
            canvas.style.width = W + 'px';
            canvas.style.height = H + 'px';

            const ctx = canvas.getContext('2d');
            ctx.scale(SCALE, SCALE);
            ctx.textBaseline = 'middle';

            // Background gradient
            const bg = ctx.createLinearGradient(0, 0, W * 0.3, H);
            bg.addColorStop(0, '#0d2818');
            bg.addColorStop(0.35, '#1a4d2e');
            bg.addColorStop(0.65, '#1a4d2e');
            bg.addColorStop(1, '#0d2818');
            ctx.fillStyle = bg;
            roundRect(ctx, 0, 0, W, H, 24); ctx.fill();

            // Decorative glow
            const glow1 = ctx.createRadialGradient(70, 80, 0, 70, 80, 280);
            glow1.addColorStop(0, 'rgba(201,168,76,.12)'); glow1.addColorStop(1, 'transparent');
            ctx.fillStyle = glow1; ctx.fillRect(0, 0, W, H);
            const glow2 = ctx.createRadialGradient(W - 70, H - 80, 0, W - 70, H - 80, 280);
            glow2.addColorStop(0, 'rgba(201,168,76,.08)'); glow2.addColorStop(1, 'transparent');
            ctx.fillStyle = glow2; ctx.fillRect(0, 0, W, H);

            // Crescent on the LEFT (no star) — drawn with canvas arcs
            ctx.save();
            ctx.globalAlpha = 0.15;
            const cresX = 52, cresY = 48, cresR = 22;
            ctx.fillStyle = '#e8c968';
            ctx.beginPath();
            ctx.arc(cresX, cresY, cresR, 0, Math.PI * 2); ctx.fill();
            // Cut inner circle to create crescent
            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(cresX + 8, cresY - 4, cresR - 3, 0, Math.PI * 2); ctx.fill();
            ctx.globalCompositeOperation = 'source-over';
            ctx.restore();

            // Logo on the RIGHT
            if (_logoImg) {
                const logoS = 64, pad = 5;
                const lx = W - 50 - logoS / 2, ly = 30;
                ctx.fillStyle = 'rgba(255,255,255,.95)';
                roundRect(ctx, lx - pad, ly - pad, logoS + pad * 2, logoS + pad * 2, 10); ctx.fill();
                ctx.drawImage(_logoImg, lx, ly, logoS, logoS);
            }

            // Header text
            const cx = W / 2;
            ctx.fillStyle = 'rgba(255,255,255,.72)';
            ctx.font = '500 13px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('المملكة العربية السعودية', cx, 50);
            ctx.fillText('المؤسسة العامة للتدريب التقني والمهني', cx, 70);
            if (unitName) {
                ctx.fillStyle = '#e8c968'; ctx.font = '600 15px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
                ctx.fillText(unitName, cx, 95);
            }

            // Title banner
            const titleY = 125, titleH2 = 38;
            const titleW = 420;
            const titleGrad = ctx.createLinearGradient(cx - titleW / 2, 0, cx + titleW / 2, 0);
            titleGrad.addColorStop(0, '#C9A84C'); titleGrad.addColorStop(0.5, '#e8c968'); titleGrad.addColorStop(1, '#C9A84C');
            ctx.fillStyle = titleGrad;
            roundRect(ctx, cx - titleW / 2, titleY - titleH2 / 2, titleW, titleH2, 12); ctx.fill();
            ctx.fillStyle = '#0d2818'; ctx.font = '700 16px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
            ctx.fillText('أوقات المحاضرات في شهر رمضان المبارك', cx, titleY + 1);

            // Semester below title
            if (semester) {
                ctx.fillStyle = 'rgba(255,255,255,.6)';
                ctx.font = '500 13px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(semester, cx, titleY + titleH2 / 2 + 16);
            }

            // Table
            let y = topSection;
            const cols = [
                { label: 'المحاضرة', x: W - 80, w: 160 },
                { label: 'البداية', x: W - 240, w: 150 },
                { label: 'النهاية', x: W - 390, w: 150 },
                { label: 'المدة', x: W - 540, w: 120 }
            ];
            const tblLeft = 35, tblRight = W - 35, tblW = tblRight - tblLeft;

            // Table header
            ctx.fillStyle = '#e8c968'; ctx.font = '600 12px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
            ctx.textAlign = 'center';
            for (const c of cols) ctx.fillText(c.label, c.x, y + headerH / 2);
            y += headerH;

            // Table rows
            for (let i = 0; i < count; i++) {
                const isEven = i % 2 === 0;
                ctx.fillStyle = isEven ? 'rgba(255,255,255,.07)' : 'rgba(255,255,255,.03)';
                roundRect(ctx, tblLeft, y, tblW, rowH, 6); ctx.fill();

                ctx.textAlign = 'center';
                // Lecture number
                ctx.fillStyle = '#a8d5ba'; ctx.font = '600 14px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
                ctx.fillText('محاضرة ' + (i + 1), cols[0].x, y + rowH / 2);
                // Start time
                ctx.fillStyle = '#fff'; ctx.font = '600 15px "Courier New", monospace';
                ctx.fillText(RS[i].s, cols[1].x, y + rowH / 2);
                // End time
                ctx.fillStyle = '#ccc'; ctx.font = '500 15px "Courier New", monospace';
                ctx.fillText(RS[i].e, cols[2].x, y + rowH / 2);
                // Duration
                ctx.fillStyle = '#e8c968'; ctx.font = '500 12px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
                ctx.fillText(LECTURE_DUR + ' د', cols[3].x, y + rowH / 2);

                y += rowH;

                // Break row
                const vb = visibleBreaks.find(b => b.idx === i);
                if (vb) {
                    ctx.fillStyle = 'rgba(255,255,255,.25)';
                    ctx.font = '400 11px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
                    ctx.fillText(vb.label, cx, y + brkH / 2);
                    y += brkH;
                }
            }

            // Notes
            if (notes) {
                y += 10;
                ctx.fillStyle = 'rgba(255,255,255,.5)';
                ctx.font = '400 12px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(notes, cx, y + 12);
                y += notesH - 10;
            }

            // Greeting
            y += 12;
            ctx.fillStyle = '#e8c968'; ctx.font = '700 20px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
            ctx.textAlign = 'center'; ctx.fillText('رمضان مبارك', cx, y + 5);
            ctx.fillStyle = 'rgba(255,255,255,.5)'; ctx.font = '400 12px "Readex Pro", "IBM Plex Sans Arabic", Tahoma, sans-serif';
            ctx.fillText('أعاده الله علينا وعليكم بالخير واليُمن والبركات', cx, y + 30);
        }

        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        function downloadRamadanCard() {
            const canvas = document.getElementById('rcCanvas');
            try {
                canvas.toBlob(blob => {
                    if (!blob) { toast('خطأ في تصدير الصورة', 'er'); return; }
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'أوقات_رمضان_' + new Date().toISOString().slice(0, 10) + '.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    toast('تم تصدير صورة أوقات رمضان بنجاح');
                }, 'image/png');
            } catch (e) {
                toast('خطأ: لا يمكن تصدير الصورة. جرّب فتح الصفحة عبر خادم محلي (Live Server)', 'er');
            }
        }

        function printRamadanCard() {
            const canvas = document.getElementById('rcCanvas');
            try {
                const dataUrl = canvas.toDataURL('image/png');
                const iframe = document.createElement('iframe');
                iframe.style.cssText = 'position:fixed;left:-9999px;width:0;height:0';
                document.body.appendChild(iframe);
                const doc = iframe.contentDocument;
                doc.open();
                doc.write('<!DOCTYPE html><html><head><title>أوقات رمضان</title><style>@page{margin:10mm}body{margin:0;display:flex;justify-content:center;align-items:flex-start}img{max-width:100%;height:auto}</style></head><body><img src="' + dataUrl + '"></body></html>');
                doc.close();
                setTimeout(() => { iframe.contentWindow.print(); setTimeout(() => iframe.remove(), 2000); }, 400);
            } catch (e) {
                toast('خطأ: لا يمكن طباعة الصورة. جرّب فتح الصفحة عبر خادم محلي (Live Server)', 'er');
            }
        }


        // ══════════════════════════════════════════════════════════
        //  INIT
        // ══════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            const uz = document.getElementById('UZ');
            uz.addEventListener('dragover', e => { e.preventDefault(); uz.classList.add('dg') });
            uz.addEventListener('dragleave', () => uz.classList.remove('dg'));
            uz.addEventListener('drop', e => { e.preventDefault(); uz.classList.remove('dg'); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]) });
            document.getElementById('FI').addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]) });
            renderSlotsUI();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        });
    </script>
</body>

</html>